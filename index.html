<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="title">LifeSync - Deepen Your Connections</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://unpkg.com/i18next@23.11.5/dist/umd/i18next.min.js"></script>
    <script src="https://unpkg.com/i18next-browser-languagedetector@7.1.0/dist/umd/i18nextBrowserLanguageDetector.min.js"></script>

    <style>
        :root {
            --bg-dark-purple: #301934;
            --bg-content-purple: rgba(45, 25, 55, 0.97);
            --bg-content-purple-opaque: rgb(45, 25, 55);
            --bg-card-purple: rgba(60, 30, 70, 0.92);
            --bg-card-purple-solid: rgb(60, 30, 70);
            --text-primary-light: #FDE7F3;
            --text-secondary-lavender: #E9D5FF;
            --accent-pink-vibrant: #DB2777;
            --accent-purple-medium: #A855F7;
            --accent-teal-bright: #2DD4BF;
            --border-color-lavender: rgba(168, 85, 247, 0.35);
            --border-color-strong: rgba(168, 85, 247, 0.65);
            --font-main: 'Poppins', sans-serif;
            --font-heading: 'Ubuntu', sans-serif;
            --nav-height: 60px;
        }
        body {
            background-color: var(--bg-dark-purple);
            color: var(--text-primary-light);
            font-family: var(--font-main);
            margin: 0;
            overflow: hidden; 
        }
        #video-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: -10;
            filter: brightness(0.25) contrast(1.1) blur(4px);
        }
        nav {
            position: fixed; top: 0; left: 0; width: 100%;
            height: var(--nav-height);
            padding: 0 20px; 
            z-index: 1000;
            display: flex; justify-content: space-between; align-items: center;
            background-color: rgba(30, 10, 40, 0.85);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-color-lavender);
            box-sizing: border-box; 
        }
        nav a.nav-brand {
            font-size: 1.4rem; font-weight: 700; color: var(--accent-teal-bright); 
            font-family: var(--font-heading);
            text-shadow: 0 0 8px var(--accent-teal-bright);
            text-decoration: none; white-space: nowrap; 
        }
        nav a.nav-brand i { margin-right: 6px; } 
        nav .nav-links { display: flex; align-items: center; flex-wrap: nowrap; overflow-x: auto; } 
        
        nav .nav-links button,
        nav .nav-links .auth-button,
        nav .nav-links select {
            background: none; border: none; padding: 6px 10px; 
            margin-left: 4px; 
            cursor: pointer; font-size: 0.85rem; 
            transition: color 0.3s ease, text-shadow 0.3s ease, transform 0.2s ease, border-bottom-color 0.3s ease;
            color: var(--text-secondary-lavender);
            font-family: var(--font-main);
            border-bottom: 2px solid transparent;
            white-space: nowrap; 
        }
        nav .nav-links button .fa-solid { margin-right: 5px; width: 16px; text-align: center; } 
        nav .nav-links button:hover,
        nav .nav-links .auth-button:hover {
            color: var(--text-primary-light);
            text-shadow: 0 0 10px var(--accent-pink-vibrant);
            transform: translateY(-1px);
        }
        nav .nav-links button.active-nav {
            color: var(--accent-teal-bright); font-weight: 600;
            text-shadow: 0 0 8px rgba(72, 209, 204, 0.7);
            border-bottom-color: var(--accent-teal-bright);
        }
        nav .nav-links .auth-button {
            padding: 4px 8px; border: 1px solid var(--accent-pink-vibrant); 
            color: var(--accent-pink-vibrant); border-radius: 16px; font-size: 0.75rem; 
        }
        nav .nav-links .auth-button:hover {
            background-color: var(--accent-pink-vibrant); color: var(--bg-dark-purple);
            text-shadow: none;
        }
        nav .nav-links .auth-button.login-btn {
            border-color: var(--accent-purple-medium); color: var(--accent-purple-medium);
        }
        nav .nav-links .auth-button.login-btn:hover {
            background-color: var(--accent-purple-medium); color: var(--bg-dark-purple);
        }
        nav .nav-links select {
            background: var(--bg-card-purple); color: var(--text-primary-light);
            border: 1px solid var(--border-color-lavender); border-radius: 5px;
            padding: 4px 6px; font-size: 0.75rem; 
        }

        .page-container {
            display: flex; flex-direction: column; height: 100vh;
            padding-top: var(--nav-height); 
            padding-bottom: 40px; 
            box-sizing: border-box;
        }
        .content-overlay {
            flex-grow: 1; display: flex; overflow-x: auto; overflow-y: hidden;
            scroll-snap-type: x mandatory; 
            width: 100%; 
            height: calc(100vh - var(--nav-height) - 40px); 
        }
        .content-overlay::-webkit-scrollbar { display: none; }
        .content-overlay { -ms-overflow-style: none; scrollbar-width: none; }

        .content-section {
            width: 100vw; height: 100%; 
            flex-shrink: 0;
            padding: 1.5rem 2rem; 
            overflow-y: auto; 
            scroll-snap-align: start;
            background-color: var(--bg-content-purple);
            box-sizing: border-box; 
            color: var(--text-primary-light);
            display: none; /* Hide sections by default */
        }
        .content-section.active-section { /* Class to show the active section */
            display: block;
        }
        .content-section::-webkit-scrollbar { width: 8px; }
        .content-section::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 10px;}
        .content-section::-webkit-scrollbar-thumb { background-color: var(--accent-purple-medium); border-radius: 10px; border: 2px solid var(--bg-content-purple); }
        .content-section::-webkit-scrollbar-thumb:hover { background-color: var(--accent-teal-bright); }
        .content-section { scrollbar-width: thin; scrollbar-color: var(--accent-purple-medium) var(--bg-content-purple); }

        h1, h2, h3, h4 { font-family: var(--font-heading); color: var(--text-primary-light); margin-bottom: 1rem; }
        h1 { font-size: 2.2rem; text-shadow: 1px 1px 3px rgba(0,0,0,0.25); } 
        h2 { font-size: 1.6rem; color: var(--accent-teal-bright); margin-top: 1.5rem; } 
        h3 { font-size: 1.25rem; color: var(--accent-pink-vibrant); margin-top: 1rem; } 
        h4 { font-size: 1.1rem; color: var(--accent-teal-bright); margin-bottom: 0.75rem; } 
        p { line-height: 1.65; color: var(--text-secondary-lavender); margin-bottom: 0.8rem; font-size: 0.9rem;} 
        ul { list-style: inside; margin-left: 1rem; margin-bottom: 0.8rem; padding-left: 0.5rem;} 
        li { margin-bottom: 0.4rem; } 

        .btn {
            display: inline-block; padding: 0.7rem 1.5rem; background-color: var(--accent-pink-vibrant);
            color: var(--text-primary-light); border: none; border-radius: 25px; cursor: pointer;
            text-decoration: none; font-size: 0.9rem; font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .btn:hover {
            background-color: #c5306c; transform: translateY(-2px) scale(1.03);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .btn-primary { background-color: var(--accent-teal-bright); color: var(--bg-dark-purple); }
        .btn-primary:hover { background-color: #26a69a; }
        .btn-secondary { background-color: var(--accent-purple-medium); }
        .btn-secondary:hover { background-color: #8e44ad; }
        .btn-purple { background-color: var(--accent-purple-medium); } 
        .btn-purple:hover { background-color: #8e44ad; }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.75rem; }

        #about { display: flex; flex-direction: column; justify-content: space-between; height: 100%; overflow-y: auto; }
        #about .hero-section {
            flex-shrink: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;
            padding: 2rem 1rem; 
            background-size: cover; background-position: center;
        }
        #about .hero-section h1 { font-size: clamp(2rem, 5vw, 3rem); margin-bottom: 0.5rem; color: var(--text-primary-light); text-shadow: 0 0 15px var(--accent-teal-bright), 0 0 25px var(--accent-teal-bright); }
        #about .hero-section .subtitle { font-size: clamp(1rem, 2.5vw, 1.25rem); margin-bottom: 1.5rem; max-width: 700px; color: var(--text-secondary-lavender); }
        #about .benefits-title-section { padding: 1rem 0; flex-shrink: 0; text-align: center; flex-grow: 0; } 
        #about .benefits-title-section h2 { font-size: clamp(1.4rem, 3vw, 1.8rem); margin-bottom: 0.2rem; }
        #about .benefits-title-section p { font-size: clamp(0.9rem, 2vw, 1.1rem); margin-bottom: 0.5rem; color: var(--accent-teal-bright); }
        .benefits-background-container { position: relative; background-color: transparent; padding: 1rem; border-radius: 8px; margin-top: 0.5rem; flex-grow: 1; display: flex; align-items: flex-start; justify-content: center; overflow-y: auto; min-height: 300px; } 
        .benefits-background-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.15; }
        #about .benefits-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; position: relative; z-index: 1; width: 100%; max-width: 900px; }
        #about .benefit-card { 
            padding: 1rem; 
            min-height: 170px; 
            display: flex; flex-direction: column; justify-content: flex-start; align-items: center; text-align: center; background-color: var(--bg-card-purple-solid); border-radius: 10px; border: 1px solid var(--border-color-strong); box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: transform 0.3s ease, box-shadow 0.3s ease; 
            cursor: pointer; 
        }
        #about .benefit-card:hover { transform: translateY(-6px); box-shadow: 0 10px 20px rgba(168, 85, 247, 0.35); }
        #about .benefit-card i { font-size: 2rem; margin-bottom: 0.75rem; color: var(--accent-teal-bright); }
        #about .benefit-card h3 { font-size: 1rem; margin-bottom: 0.4rem; color: var(--accent-pink-vibrant); }
        #about .benefit-card p { font-size: 0.78rem; line-height: 1.45; color: var(--text-secondary-lavender); } 
        #about .landing-cta-section { padding: 1.5rem 0; margin-top: 1rem; flex-shrink: 0; text-align: center; }
        #about .landing-cta-section h2 { font-size: 1.3rem; margin-bottom: 0.5rem; }
        #about .landing-cta-section p { font-size: 1rem; margin-bottom: 1.2rem; }
        #about .landing-cta-section .btn { margin: 0.5rem; padding: 0.8rem 1.8rem; }

        .value-prop-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
        .value-prop-card { background-color: var(--bg-card-purple); padding: 1.5rem; border-radius: 10px; border: 1px solid var(--border-color-strong); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .value-prop-card i.card-icon { font-size: 2.2rem; color: var(--accent-teal-bright); margin-bottom: 1rem; display: block; text-align: center; }
        .value-prop-card h4 { color: var(--accent-pink-vibrant); font-size: 1.2rem; margin-bottom: 0.6rem; text-align: center; }

        .assessment-container, .quiz-container { background-color: var(--bg-card-purple); padding: 2rem; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.45); width: 100%; max-width: 700px; margin: 1.5rem auto; }
        .assessment-question, .quiz-question { margin-bottom: 1.5rem; }
        .assessment-question p, .quiz-question p, .quiz-question h4 { font-size: 1.05rem; color: var(--text-primary-light); font-weight: 600; margin-bottom: 0.5rem;}
        .assessment-options button, .quiz-options button { padding: 0.8rem 1.2rem; margin: 0.5rem 0; font-size: 0.95rem; display: block; width: 100%; background-color: var(--bg-content-purple-opaque); border: 1px solid var(--border-color-lavender); color: var(--text-primary-light); border-radius: 8px; cursor: pointer; transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease, transform 0.2s ease; }
        .assessment-options button:hover, .quiz-options button:hover { background-color: var(--accent-purple-medium); border-color: var(--accent-purple-medium); color: var(--text-primary-light); transform: translateX(5px); }
        .assessment-options button.selected, .quiz-options button.selected { background-color: var(--accent-teal-bright); border-color: var(--accent-teal-bright); color: var(--bg-dark-purple); font-weight: 600; }
        .assessment-feedback, .quiz-feedback { margin-top: 1.5rem; font-size: 0.9rem; font-style: italic; color: var(--accent-pink-vibrant); min-height: 22px; text-align: center;}
        .progress-bar-container { margin-top: 1rem; width: 100%; background-color: var(--border-color-lavender); border-radius: 8px; overflow: hidden; padding: 3px; }
        .progress-bar-fill { height: 12px; display:block; width: 0%; background-color: var(--accent-teal-bright); border-radius: 5px; transition: width 0.5s ease-in-out; text-align: center; font-size:0.7rem; line-height:12px; color: var(--bg-dark-purple);}
        .weight-slider { margin-top: 0.75rem; }
        .weight-slider label { font-size: 0.85rem; color: var(--text-secondary-lavender); margin-right: 0.5rem;}
        .weight-slider input[type="range"] { width: calc(60% - 30px); accent-color: var(--accent-pink-vibrant); vertical-align: middle;}
        .weight-slider span { font-size: 0.85rem; color: var(--text-primary-light); margin-left: 5px; display: inline-block; width: 20px; text-align: center;}
        #quickCompatLevelSelector button { margin: 0.25rem; }

        .resource-category-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .resource-category-card { padding: 1.5rem; background-color: var(--bg-card-purple); border-radius: 10px; border: 1px solid var(--border-color-strong); box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center; cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .resource-category-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(168, 85, 247, 0.4); }
        .resource-category-card i.fa-2x { font-size: 2.8rem; color: var(--accent-teal-bright); margin-bottom: 1rem;}
        .resource-category-card h4 { font-size: 1.3rem; color: var(--accent-pink-vibrant); margin-bottom: 0.6rem;}
        #resourceItemList .value-prop-card { padding: 1.2rem; text-align: left; margin-bottom: 1.2rem;}
        #resourceItemList .value-prop-card h5 { color: var(--accent-teal-bright); font-size: 1.15rem; margin-bottom: 0.5rem;}
        #resourceItemList .value-prop-card p { font-size: 0.9rem; color: var(--text-secondary-lavender); margin-bottom: 0.8rem;}
        #resourceItemList .value-prop-card a.btn { font-size: 0.8rem; padding: 0.5rem 1rem;}
        #resourceWizardArea { background-color: var(--bg-card-purple-solid); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; }
        #resourceWizardArea h3 { color: var(--accent-teal-bright); margin-bottom: 1rem; }
        .wizard-section { margin-bottom: 1rem; }
        .wizard-section label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; }
        .wizard-section select, .wizard-section input.input-field { 
            width: 100%; padding: 0.7rem; background-color: var(--bg-content-purple-opaque);
            border: 1px solid var(--border-color-lavender); color: var(--text-primary-light);
            border-radius: 5px; margin-bottom: 0.5rem; box-sizing: border-box;
        }
        #resourceCategoriesGrid details summary { cursor: pointer; font-weight: 600; color: var(--accent-teal-bright); padding: 0.5rem; background-color: var(--bg-card-purple-solid); border-radius: 5px; margin-bottom: 0.5rem; }
        #resourceCategoriesGrid details ul { list-style: none; padding-left: 1rem; }
        #resourceCategoriesGrid details li { padding: 0.25rem 0; cursor: pointer; }
        #resourceCategoriesGrid details li:hover { color: var(--accent-pink-vibrant); }

        .form-section { background-color: var(--bg-card-purple); padding: 2rem; border-radius: 12px; margin: 1.5rem auto; max-width: 700px; box-shadow: 0 8px 25px rgba(0,0,0,0.45); }
        .form-field-group { margin-bottom: 1.25rem; }
        .form-field-group label { display: block; font-size: 0.95rem; color: var(--text-secondary-lavender); margin-bottom: 0.5rem; font-weight: 600;}
        .input-field, 
        .form-field-group input[type="text"], .form-field-group input[type="email"], .form-field-group input[type="date"], .form-field-group input[type="url"], .form-field-group input[type="password"], .form-field-group select, .form-field-group textarea {
            width: 100%; background-color: var(--bg-content-purple-opaque); border: 1px solid var(--border-color-lavender);
            color: var(--text-primary-light); padding: 0.8rem 1rem; border-radius: 8px; font-size: 0.9rem;
            box-sizing: border-box; transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .input-field:focus, .form-field-group input:focus, .form-field-group select:focus, .form-field-group textarea:focus {
            border-color: var(--accent-teal-bright); box-shadow: 0 0 8px rgba(45, 212, 191, 0.5); outline: none;
        }
        .form-field-group textarea { min-height: 80px; resize: vertical; }
        #ugqCreationFormArea h3, #profile h3.form-title { margin-bottom: 1.5rem; text-align: center;} 

        .profileImagePreviewStyle {
            width: 120px; height: 120px; border-radius: 50%;
            background-color: var(--bg-card-purple-solid);
            margin: 0 auto 0.5rem;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-secondary-lavender);
            border: 3px dashed var(--border-color-lavender);
            cursor: pointer; transition: border-color 0.3s ease, background-color 0.3s ease;
            font-size: 3rem; 
            object-fit: cover; 
        }
        .profileImagePreviewStyle:hover {
            border-color: var(--accent-teal-bright);
            background-color: var(--bg-content-purple-opaque);
        }
        .profileImagePreviewStyle img {
            width:100%; height:100%; border-radius:50%; object-fit:cover;
        }
        #profileImageUpload { display: none; }

        #profileCompletionContainer { margin: 1rem auto; padding: 0.75rem; background-color: var(--bg-card-purple-solid); border-radius: 8px; max-width: 700px;}
        #profileCompletionBarContainer { width: 100%; background-color: var(--border-color-lavender); border-radius: 8px; overflow: hidden; margin: 0.25rem 0; padding:3px; }
        #profileCompletionBar { height: 12px; background-color: var(--accent-teal-bright); width: 0%; border-radius: 5px; transition: width 0.5s ease-in-out; text-align: right; padding-right: 5px; font-size: 0.7rem; color: var(--bg-dark-purple); line-height: 12px; }
        #profileCompletionPercentageText { font-size: 0.85rem; text-align: right; color: var(--text-secondary-lavender); } 
        #profileCompletionHint { font-size: 0.75rem; text-align: center; margin-top: 0.25rem; color: var(--text-secondary-lavender); }

        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); 
            align-items: center; justify-content: center; padding: 1rem; animation: modalFadeIn 0.3s ease-out;
        }
        .modal.active { display: flex; } 
        @keyframes modalFadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-content {
            background-color: var(--bg-card-purple-solid); margin: auto; padding: 25px;
            border: 1px solid var(--border-color-strong); width: 90%; max-width: 500px;
            border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            color: var(--text-primary-light); position: relative;
        }
        .modal-content h2 { color: var(--accent-teal-bright); margin-top: 0; font-size: 1.5rem; }
        .close-button {
            color: var(--text-secondary-lavender); position: absolute; top: 10px; right: 15px;
            font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s ease;
        }
        .close-button:hover, .close-button:focus { color: var(--accent-pink-vibrant); text-decoration: none; }
        
        .notifications-area {
            position: fixed;
            bottom: 60px; 
            right: 20px;
            width: 300px;
            z-index: 3000;
        }
        .notification-item {
            background-color: var(--bg-card-purple-solid);
            color: var(--text-primary-light);
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            border-left: 4px solid var(--accent-teal-bright);
            font-size: 0.85rem;
            opacity: 0;
            transform: translateX(100%);
            animation: slideInNotification 0.5s forwards;
        }
        .notification-item.error { border-left-color: var(--accent-pink-vibrant); }
        .notification-item.success { border-left-color: var(--accent-teal-bright); }
        .notification-item.info { border-left-color: var(--accent-purple-medium); }
        @keyframes slideInNotification {
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes slideOutNotification { 
            from { opacity: 1; transform: translateX(0); } 
            to { opacity: 0; transform: translateX(100%); } 
        }

        #globalSearchTriggerBtn { 
            position: fixed; bottom: 60px; 
            left: 20px; z-index: 1000;
            background-color: var(--accent-purple-medium); color: var(--text-primary-light);
            border: none; border-radius: 50%; width: 50px; height: 50px;
            font-size: 1.2rem; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }
        #globalSearchTriggerBtn:hover { background-color: #8e44ad; transform: scale(1.1); }

        footer {
            text-align: center; padding: 1rem; color: var(--text-secondary-lavender);
            font-size: 0.8rem; background-color: rgba(30,10,40,0.7);
            border-top: 1px solid var(--border-color-lavender);
            width: 100%; box-sizing: border-box;
            position: fixed; bottom: 0; left: 0; z-index: 500; 
            height: 40px; 
            display:flex; align-items:center; justify-content:center;
        }

        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.65); z-index: 4000; display: none; 
            align-items: center; justify-content: center;
        }
        .loading-spinner {
            border: 5px solid var(--text-secondary-lavender);
            border-top: 5px solid var(--accent-teal-bright);
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Adjustments */
        @media (max-width: 1024px) { 
            .nav-text-long { display: none; }
            .nav-text-short { display: inline; }
            nav a.nav-brand { font-size: 1.3rem; }
            nav .nav-links button, nav .nav-links .auth-button, nav .nav-links select { font-size: 0.8rem; padding: 5px 8px; }
             #about .hero-section h1 { font-size: clamp(1.8rem, 4vw, 2.5rem); }
            #about .hero-section .subtitle { font-size: clamp(0.9rem, 2vw, 1.1rem); }
            #about .benefits-grid { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; }
            .benefits-background-container { padding: 0.5rem; min-height: 250px; } 
            .assessment-container { padding: 1.5rem; }
            .form-section { padding: 1.5rem; }
            .modal-content { width: 95%; max-width: 400px; padding: 20px; }
        }
        @media (min-width: 1025px) {
            .nav-text-short { display: none; }
            .nav-text-long { display: inline; }
        }
         @media (max-width: 768px) {
            nav { padding: 0 15px; }
            nav a.nav-brand { font-size: 1.2rem; }
            nav .nav-links button, nav .nav-links .auth-button, nav .nav-links select { font-size: 0.75rem; padding: 4px 6px; }
            .content-section { padding: 1rem 1.5rem; }
            #about .hero-section h1 { font-size: clamp(1.5rem, 3.5vw, 2rem); }
            #about .hero-section .subtitle { font-size: clamp(0.85rem, 1.8vw, 1rem); }
            #about .benefits-title-section h2 { font-size: clamp(1.2rem, 2.5vw, 1.5rem); }
            #about .benefits-grid { grid-template-columns: 1fr; } 
            .benefits-background-container { min-height: auto; } 
            .value-prop-grid { grid-template-columns: 1fr; }
            .resource-category-grid { grid-template-columns: 1fr; }
            .modal-content { width: 90%; max-width: 350px; padding: 15px; }
            .notifications-area { width: 250px; right: 10px; }
            #globalSearchTriggerBtn { width: 40px; height: 40px; font-size: 1rem; }
            footer { font-size: 0.7rem; padding: 0.5rem; }
        }
         @media (max-width: 480px) {
            nav { padding: 0 10px; }
            nav a.nav-brand { font-size: 1.1rem; }
            nav .nav-links button, nav .nav-links .auth-button, nav .nav-links select { font-size: 0.7rem; padding: 3px 5px; margin-left: 2px;}
            .content-section { padding: 1rem; }
            #about .hero-section h1 { font-size: clamp(1.3rem, 3vw, 1.8rem); }
            #about .hero-section .subtitle { font-size: clamp(0.8rem, 1.5vw, 0.9rem); }
            #about .benefits-title-section h2 { font-size: clamp(1rem, 2vw, 1.3rem); }
            #about .benefits-title-section p { font-size: clamp(0.8rem, 1.5vw, 0.9rem); }
            #about .benefit-card { padding: 1rem; min-height: 120px; }
            #about .benefit-card i { font-size: 1.5rem; }
            #about .benefit-card h3 { font-size: 0.9rem; }
            #about .benefit-card p { font-size: 0.75rem; }
            .btn { padding: 0.5rem 1rem; font-size: 0.8rem; }
            .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.65rem; }
            .assessment-container { padding: 1rem; }
            .form-field-group input, .form-field-group textarea, .form-field-group select { padding: 0.6rem 0.8rem; font-size: 0.85rem;}
            .modal-content { width: 85%; max-width: 300px; padding: 10px; }
            .modal-content h2 { font-size: 1.2rem; }
            .notifications-area { width: 200px; }
            .notification-item { font-size: 0.75rem; padding: 8px 12px; }
            #globalSearchTriggerBtn { bottom: 50px; left: 10px; }
            footer { font-size: 0.65rem; }
        }
        /* Utility classes */
        .text-center { text-align: center; }
        .mb-6 { margin-bottom: 1.5rem; } 
        .mt-3 { margin-top: 0.75rem; } 
        .mt-4 { margin-top: 1rem; } 
        .mt-6 { margin-top: 1.5rem; }
        .mt-8 { margin-top: 2rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .my-2 { margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .my-4 { margin-top: 1rem; margin-bottom: 1rem; }
        .grid { display: grid; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        .w-full { width: 100%; }
        .max-w-4xl { max-width: 56rem; } 
        .mx-auto { margin-left: auto; margin-right: auto; }
        .items-start { align-items: flex-start; }
        .form-checkbox { 
            appearance: none;
            background-color: var(--bg-content-purple-opaque);
            border: 1px solid var(--border-color-lavender);
            padding: 0.35em;
            border-radius: 3px;
            display: inline-block;
            position: relative;
            vertical-align: middle;
            margin-right: 0.25rem;
        }
        .form-checkbox:checked {
            background-color: var(--accent-teal-bright);
            border-color: var(--accent-teal-bright);
        }
        .form-checkbox:checked::after {
            content: '✔';
            font-size: 0.8em;
            color: var(--bg-dark-purple);
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .mr-2 { margin-right: 0.5rem; }
        .text-lg { font-size: 1.125rem; } 
        .text-xl { font-size: 1.25rem; } 
        .text-2xl { font-size: 1.5rem; } 
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .font-medium { font-weight: 500; }
        .italic { font-style: italic; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded { border-radius: 0.25rem; }
        .p-3 { padding: 0.75rem; }
        .max-h-60 { max-height: 15rem; } 
        .overflow-y-auto { overflow-y: auto; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <video autoplay muted loop playsinline id="video-background" poster="https://placehold.co/1920x1080/301934/FDE7F3?text=LifeSync+Background">
        <source src="https://www.coverr.co/s3/mp4/Abstract_Plexus.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <nav role="navigation" aria-label="Main navigation">
        <a href="#" class="nav-brand" data-target="about"><i class="fas fa-sync-alt"></i> <span data-i18n="nav.brand">LifeSync</span></a>
        <div class="nav-links">
            <button data-target="about" class="active-nav"><i class="fa-solid fa-house"></i> <span data-i18n="nav.home">Home</span></button>
            <button data-target="assessments"><i class="fa-solid fa-tasks"></i> <span data-i18n="nav.assessments">Assessments</span></button>
            <button data-target="tools"><i class="fa-solid fa-tools"></i> <span data-i18n="nav.tools">Tools</span></button>
            <button data-target="resources"><i class="fa-solid fa-book-open"></i> <span data-i18n="nav.resources">Resources</span></button>
            <button data-target="ugq"><i class="fas fa-question-circle"></i> <span data-i18n="profile.ugqTitle" class="nav-text-short">My Q's</span><span class="nav-text-long" data-i18n="profile.ugqTitleLong">My Questions</span></button> 
            <button data-target="profile" id="navProfileBtn" style="display:none;"><i class="fa-solid fa-user-circle"></i> <span data-i18n="nav.profile">My Profile</span></button>
            
            <button class="auth-button login-btn" id="loginBtnNav"><i class="fa-solid fa-sign-in-alt"></i> <span data-i18n="nav.login">Login</span></button>
            <button class="auth-button" id="registerBtnNav"><i class="fa-solid fa-user-plus"></i> <span data-i18n="nav.register">Register</span></button>
            <button class="auth-button" id="logoutBtnNav" style="display:none;"><i class="fa-solid fa-sign-out-alt"></i> <span data-i18n="nav.logout">Logout</span></button>
            
            <select id="languageSelector" aria-label="Select Language">
                <option value="en">English</option>
                <option value="xh">isiXhosa</option>
                <option value="zu">isiZulu</option>
                <option value="af">Afrikaans</option>
                <option value="nso">Sepedi</option>
                <option value="st">Sesotho</option>
                <option value="tn">Setswana</option>
                <option value="ss">siSwati</option>
                <option value="ts">Xitsonga</option>
                <option value="ve">Tshivenda</option>
                <option value="nr">isiNdebele</option>
                </select>
        </div>
    </nav>

    <div class="page-container">
        <div class="content-overlay" id="content-overlay">
            <section id="about" class="content-section active-section" role="main" aria-labelledby="about-heading">
                <div class="hero-section" style="background-image: linear-gradient(rgba(45, 25, 55, 0.85), rgba(30, 10, 40, 0.98)), url('https://images.unsplash.com/photo-1503435824048-a79953604125?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1200&q=80&blend=301934&blend-mode=multiply&blend-alpha=50');">
                    <h1 id="about-heading" data-i18n="landing.heroTitle">Beyond the Swipe: Discover True Compatibility</h1>
                    <p class="subtitle" data-i18n="landing.heroSubtitle">LifeSync empowers you to understand yourself and what you truly need in any significant relationship. Build your dynamic, lifelong profile, 'Sync Up' for profound connections, and always be ready for your best relationship journey.</p>
                    <button class="btn btn-primary" data-target="assessments" data-i18n="landing.heroCta">Explore Assessments</button>
                </div>
                <div class="benefits-title-section">
                    <h2 data-i18n="landing.benefitsTitle">Why LifeSync? The Path to Deeper Understanding.</h2>
                    <p data-i18n="landing.benefitsSubtitle">LifeSync is more than an app; it's your companion for relationship clarity and growth.</p>
                </div>
                <div class="benefits-background-container">
                    <svg class="benefits-background-svg" viewBox="0 0 200 100" preserveAspectRatio="none" aria-hidden="true">
                        <defs>
                            <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:var(--accent-purple-medium);stop-opacity:0.5" />
                                <stop offset="100%" style="stop-color:var(--accent-pink-vibrant);stop-opacity:0.5" />
                            </linearGradient>
                            <filter id="blurFilter"><feGaussianBlur in="SourceGraphic" stdDeviation="2"/></filter>
                        </defs>
                        <circle cx="30" cy="30" r="25" fill="url(#grad1)" filter="url(#blurFilter)"/>
                        <circle cx="170" cy="70" r="30" fill="url(#grad1)" opacity="0.7" filter="url(#blurFilter)"/>
                        <path d="M0,50 Q50,20 100,50 T200,50" stroke="var(--accent-teal-bright)" stroke-width="1" fill="none" opacity="0.4"/>
                        <path d="M0,60 Q60,90 120,60 T200,70" stroke="var(--accent-pink-vibrant)" stroke-width="0.5" fill="none" opacity="0.3"/>
                    </svg>
                    <div class="benefits-grid">
                        <div class="benefit-card" data-benefit-id="benefit1">
                            <i class="fas fa-user-edit"></i> <h3 data-i18n="landing.benefit1.title">Build Your Lifelong Profile</h3>
                            <p data-i18n="landing.benefit1.description">Create a rich, evolving profile that captures your values, preferences, and experiences – your personal relationship blueprint.</p>
                        </div>
                        <div class="benefit-card" data-benefit-id="benefit2">
                            <i class="fas fa-brain"></i> <h3 data-i18n="landing.benefit2.title">Understand Yourself Deeper</h3>
                            <p data-i18n="landing.benefit2.description">Engage with 150+ culturally aware questions. Gain personalized insights into your needs and compatibility factors.</p>
                        </div>
                        <div class="benefit-card" data-benefit-id="benefit3">
                            <i class="fas fa-people-arrows"></i> <h3 data-i18n="landing.benefit3.title">Ready to 'Sync Up'?</h3>
                            <p data-i18n="landing.benefit3.description">Connect with a partner on a new level. Securely share and compare what truly matters, with full, granular consent.</p>
                        </div>
                        <div class="benefit-card" data-benefit-id="benefitImport">
                            <i class="fas fa-file-import"></i> <h3 data-i18n="landing.benefitImport.title">Seamless Profile Building</h3>
                            <p data-i18n="landing.benefitImport.description">Easily import data from existing social/dating profiles or use AI assistance to extract info from documents like your CV. Spend less time typing, more time connecting.</p>
                        </div>
                    </div>
                </div>
                <div class="landing-cta-section">
                    <h2 data-i18n="landing.getStartedTitle">Ready to Begin Your Journey?</h2>
                    <p data-i18n="landing.getStartedSubtitle">Create your free LifeSync profile today and take the first step towards more meaningful connections.</p>
                    <button class="btn btn-primary" data-target="assessments" data-i18n="landing.takeAssessmentCta">Take an Assessment</button>
                    <button class="btn btn-secondary" id="registerBtnLanding" data-i18n="landing.registerNow">Register Your Profile</button>
                    <button class="btn btn-purple" id="loginBtnLanding" data-i18n="landing.loginExisting">Login</button>
                </div>
            </section>

            <section id="assessments" class="content-section" role="region" aria-labelledby="assessments-heading">
                <h2 id="assessments-heading" class="text-center" data-i18n="assessments.title">Discover Your Compatibility</h2>
                <p class="text-center mb-6" data-i18n="assessments.subtitle">Engage with our assessments to gain valuable insights into your relationship dynamics. Assign weights to what matters most to you!</p>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="assessment-container">
                        <h3 class="form-title"><i class="fas fa-rocket mr-2"></i> <span data-i18n="assessments.quickCompat.title">Quick Compatibility Check</span></h3>
                        <p data-i18n="assessments.quickCompat.description">A fast way for you and a potential partner to get an initial feel for alignment. Choose your depth!</p>
                        <div id="quickCompatLevelSelector" class="my-4 text-center">
                            <button class="btn btn-secondary btn-sm" data-level="basic" data-i18n="assessments.quickCompat.basicBtn">Quick Sync (5 Q's)</button>
                            <button class="btn btn-secondary btn-sm" data-level="intermediate" data-i18n="assessments.quickCompat.intermediateBtn">Deeper Dive (10 Q's)</button>
                            <button class="btn btn-secondary btn-sm" data-level="advanced" data-i18n="assessments.quickCompat.advancedBtn">Full Spectrum (15 Q's)</button>
                        </div>
                        <div id="quickCompatQuizArea" style="display:none;">
                            <div class="quiz-question">
                                <h4 id="quickCompatQuestionText" class="text-lg mb-2"></h4>
                                <div class="quiz-options" id="quickCompatOptionsArea"></div>
                                <div class="weight-slider mt-3">
                                    <label for="quickCompatWeight" data-i18n="assessments.quickCompat.importanceLabel">Importance (1-5):</label>
                                    <input type="range" id="quickCompatWeight" name="quickCompatWeight" min="1" max="5" value="3">
                                    <span id="quickCompatWeightValue">3</span>
                                </div>
                            </div>
                            <div class="quiz-feedback" id="quickCompatFeedbackArea"></div>
                            <p class="text-xs mt-3 text-center"><span data-i18n="assessments.quickCompat.progressQuestion">Question</span> <span id="quickCompatCounter">1</span> <span data-i18n="assessments.quickCompat.progressOf">of</span> <span id="quickCompatTotal">5</span></p>
                            <div class="progress-bar-container mt-2"><div class="progress-bar-fill" id="quickCompatProgressBar">0%</div></div>
                            <button id="quickCompatNextBtn" class="btn btn-primary w-full mt-4" data-i18n="assessments.quickCompat.nextBtn">Next</button>
                        </div>
                        <div id="quickCompatResultArea" style="display:none;" class="mt-4 text-center">
                            <h4 class="text-xl" style="color: var(--accent-teal-bright);" data-i18n="assessments.quickCompat.resultsTitle">Quick Sync Results!</h4>
                            <p id="quickCompatFinalFeedback" class="my-2"></p>
                            <button class="btn btn-secondary" id="resetQuickCompatBtn" data-i18n="assessments.quickCompat.retryBtn">Try Another Level</button>
                        </div>
                    </div>
                    <div class="assessment-container">
                        <h3 class="form-title"><i class="fas fa-user-edit mr-2"></i> <span data-i18n="assessments.profileBuilder.title">My Relationship Profile Builder</span></h3>
                        <p data-i18n="assessments.profileBuilder.description">Build your detailed LifeSync profile by answering these questions about your views, preferences, lifestyle, and more. This forms the basis for future syncs and deeper insights.</p>
                        <div id="relationshipDetailsQuizArea">
                            <div class="quiz-question">
                                <h4 id="detailsQuestionText" class="text-lg mb-2"></h4>
                                <div class="quiz-options" id="detailsOptionsArea"></div>
                                <div class="weight-slider mt-3">
                                    <label for="detailsWeight" data-i18n="assessments.profileBuilder.importanceLabel">How crucial is this for you? (1-5):</label>
                                    <input type="range" id="detailsWeight" name="detailsWeight" min="1" max="5" value="3">
                                    <span id="detailsWeightValue">3</span>
                                </div>
                            </div>
                            <div class="quiz-feedback" id="detailsFeedbackArea"></div>
                            <p class="text-xs mt-3 text-center"><span data-i18n="assessments.profileBuilder.progressQuestion">Question</span> <span id="detailsCounter">1</span> <span data-i18n="assessments.profileBuilder.progressOf">of</span> <span id="detailsTotal">10</span></p>
                            <div class="progress-bar-container mt-2"><div class="progress-bar-fill" id="detailsProgressBar">0%</div></div>
                            <button id="detailsNextBtn" class="btn btn-primary w-full mt-4" data-i18n="assessments.profileBuilder.nextBtn">Next Question</button>
                        </div>
                        <div id="detailsResultArea" style="display:none;" class="mt-4 text-center">
                            <h4 class="text-xl" style="color: var(--accent-teal-bright);" data-i18n="assessments.profileBuilder.resultsTitle">Profile Section Complete!</h4>
                            <p id="detailsFinalFeedback" class="my-2"></p>
                            <button class="btn btn-secondary" id="resetDetailsQuizBtn" data-i18n="assessments.profileBuilder.reviewBtn">Review Answers</button>
                            <button class="btn btn-primary" data-target="profile" id="viewProfileFromAssessment" data-i18n="assessments.profileBuilder.viewProfileBtn">View My Profile</button>
                        </div>
                    </div>
                </div>
                <p class="text-center mt-8 text-sm" data-i18n="assessments.note">More in-depth assessments on finances, cultural values (e.g., lobola discussions, family roles), lifestyle, and long-term goals are available once you create your profile and connect with a partner.</p>
            </section>
            
            <section id="tools" class="content-section" role="region" aria-labelledby="tools-heading">
                <h2 id="tools-heading" class="text-center" data-i18n="tools.title">Relationship Enhancement Tools</h2>
                <p class="text-center mb-6" data-i18n="tools.subtitle">Access a suite of tools designed to foster communication, track progress, and navigate challenges together.</p>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="value-prop-card text-center">
                        <i class="fas fa-comments text-3xl mb-3 card-icon" style="color: var(--accent-purple-medium);"></i>
                        <h4 data-i18n="tools.communication.title">Communication Guides</h4>
                        <p data-i18n="tools.communication.description">Structured prompts and guides for discussing sensitive topics like finances, family expectations, and future plans.</p>
                        <button class="btn btn-secondary btn-sm mt-3" id="toolCommGuidesBtn" data-i18n="tools.explore">Explore Resources</button>
                    </div>
                    <div class="value-prop-card text-center">
                        <i class="fas fa-calendar-check text-3xl mb-3 card-icon" style="color: var(--accent-purple-medium);"></i>
                        <h4 data-i18n="tools.milestone.title">Milestone & Date Tracker</h4>
                        <p data-i18n="tools.milestone.description">Log important dates, anniversaries, and relationship milestones. Get reminders and celebrate together.</p>
                        <button class="btn btn-secondary btn-sm mt-3" data-i18n="tools.comingSoon" disabled>Set Up (Coming Soon)</button>
                    </div>
                    <div class="value-prop-card text-center">
                        <i class="fas fa-chart-line text-3xl mb-3 card-icon" style="color: var(--accent-purple-medium);"></i>
                        <h4 data-i18n="tools.monitoring.title">Parameter Monitoring</h4>
                        <p data-i18n="tools.monitoring.description">Track changes in key relationship aspects (e.g., frequency of affirming words, shared activities) and get gentle nudges.</p>
                        <button class="btn btn-secondary btn-sm mt-3" data-i18n="tools.comingSoon" disabled>Configure (Coming Soon)</button>
                    </div>
                    <div class="value-prop-card text-center">
                        <i class="fas fa-hands-helping text-3xl mb-3 card-icon" style="color: var(--accent-purple-medium);"></i>
                        <h4 data-i18n="tools.conflict.title">Conflict Resolution Aids</h4>
                        <p data-i18n="tools.conflict.description">Tools to help navigate disagreements constructively, including structured feedback exchange.</p>
                        <button class="btn btn-secondary btn-sm mt-3" id="toolConflictAidsBtn" data-i18n="tools.explore">Explore Resources</button>
                    </div>
                    <div class="value-prop-card text-center">
                        <i class="fas fa-gift text-3xl mb-3 card-icon" style="color: var(--accent-purple-medium);"></i>
                        <h4 data-i18n="tools.goals.title">Shared Goals & Dreams</h4>
                        <p data-i18n="tools.goals.description">Define and track progress towards shared aspirations as a couple.</p>
                        <button class="btn btn-secondary btn-sm mt-3" data-i18n="tools.comingSoon" disabled>Start Planning (Coming Soon)</button>
                    </div>
                    <div class="value-prop-card text-center">
                        <i class="fas fa-user-minus text-3xl mb-3 card-icon" style="color: var(--accent-purple-medium);"></i>
                        <h4 data-i18n="tools.closure.title">Relationship Closure (If Needed)</h4>
                        <p data-i18n="tools.closure.description">Tools to facilitate a respectful and clear process if a relationship ends.</p>
                        <button class="btn btn-secondary btn-sm mt-3" id="toolClosureAidsBtn" data-i18n="tools.explore">Explore Resources</button>
                    </div>
                </div>
            </section>

            <section id="resources" class="content-section" role="region" aria-labelledby="resources-heading">
                <h2 id="resources-heading" class="text-center" data-i18n="resources.pageTitle">Relationship Resources Hub</h2>
                <p class="text-center mb-4" data-i18n="resources.pageSubtitle">Explore a curated list of tools, services, and information to support your relationship journey.</p>
                
                <div id="resourceWizardArea">
                    <h3 data-i18n="resources.wizard.title">Resource Discovery Wizard</h3>
                    <details class="mb-4 bg-[var(--bg-card-purple-solid)] p-3 rounded-lg">
                        <summary class="font-semibold cursor-pointer text-[var(--accent-teal-bright)]" data-i18n="resources.wizard.introTitle">How to Use This Section <i class="fas fa-chevron-down ml-2 text-xs"></i></summary>
                        <p class="text-sm mt-2" data-i18n="resources.wizard.introText">Use the search bar below to find specific resources, or browse through the categories. Click on a category to see available items. Automated suggestions based on your profile will be available soon!</p>
                    </details>
                    <div class="wizard-section">
                        <p data-i18n="resources.wizard.automatedIntro">Based on your profile, we might have some suggestions for you (Feature Coming Soon!).</p>
                        <div id="suggestedResourcesContainer" class="mt-2"></div>
                        <button class="btn btn-sm btn-purple mt-2 !text-xs" disabled data-i18n="resources.wizard.customizeBtn">Customize Suggestions (Coming Soon)</button>
                    </div>
                    <div class="wizard-section mt-4">
                        <label for="resourceSearchInput" data-i18n="resources.wizard.searchLabel">Search All Resources:</label>
                        <input type="text" id="resourceSearchInput" class="input-field" data-i18n-placeholder="resources.wizard.searchPlaceholder" placeholder="e.g., counseling, dating apps...">
                        <button id="resourceSearchBtn" class="btn btn-primary mt-2 btn-sm" data-i18n="resources.wizard.searchBtn">Search</button>
                    </div>
                    <h4 class="text-lg mt-6 mb-2" data-i18n="resources.wizard.browseCategories">Or Browse Categories:</h4>
                    <div id="resourceCategoriesGrid" class="resource-category-grid"></div>
                </div>
                <div id="resourceDetailView" class="mt-6" style="display: none;">
                    <button id="backToCategoriesBtn" class="btn btn-secondary mb-4"><i class="fas fa-arrow-left mr-2"></i> <span data-i18n="resources.backToCategories">Back to Categories</span></button>
                    <h3 id="resourceDetailTitle" class="text-2xl mb-4 text-center"></h3>
                    <div id="resourceItemList" class="grid md:grid-cols-2 gap-4"></div>
                </div>
            </section>

            <section id="ugq" class="content-section" role="region" aria-labelledby="ugq-heading">
                <h2 id="ugq-heading" class="text-center" data-i18n="profile.ugqTitle">My Custom Questions</h2>
                <p class="text-center" data-i18n="ugq.subtitle">Create your own questions to explore specific areas of compatibility that matter most to you and your partner.</p>
                
                <div id="ugqCreationFormArea" class="form-section">
                    <h3 class="form-title" data-i18n="profile.ugqCreateTitle">Create a New Question</h3>
                    <form id="ugqForm">
                        <div class="form-field-group">
                            <label for="ugqText" data-i18n="profile.ugqQuestionLabel">Your Question:</label>
                            <textarea id="ugqText" name="ugqText" class="input-field" data-i18n-placeholder="profile.ugqQuestionPlaceholder" placeholder="e.g., What's your ideal Sunday?"></textarea>
                        </div>
                        <div class="form-field-group">
                            <label for="ugqAnswer" data-i18n="profile.ugqAnswerLabel">Your Answer to this Question:</label>
                            <textarea id="ugqAnswer" name="ugqAnswer" class="input-field" data-i18n-placeholder="profile.ugqAnswerPlaceholder" placeholder="e.g., A mix of adventure and relaxation."></textarea>
                        </div>
                        <div class="form-field-group">
                            <label for="ugqCategory" data-i18n="profile.ugqCategoryLabel">Category (Optional):</label>
                            <input type="text" id="ugqCategory" name="ugqCategory" class="input-field" data-i18n-placeholder="profile.ugqCategoryPlaceholder" placeholder="e.g., Lifestyle, Values">
                        </div>
                        <div class="form-field-group">
                            <input type="checkbox" id="ugqIsPrivate" name="ugqIsPrivate" checked style="width:auto; margin-right: 5px;" class="form-checkbox h-4 w-4 text-[var(--accent-teal-bright)] rounded">
                            <label for="ugqIsPrivate" style="display:inline; font-weight:normal;" data-i18n="ugq.privateLabel">Keep this question private (only visible to you and synced partners you share with)</label>
                        </div>
                        <button type="submit" id="saveUgqBtn" class="btn btn-primary w-full" data-i18n="profile.ugqSaveBtn"><i class="fas fa-plus-circle"></i> Add Question</button>
                    </form>
                </div>
                
                <div id="ugqListDisplayArea" class="mt-6">
                    <h3 class="text-center" data-i18n="ugq.yourQuestionsTitle">Your Created Questions</h3>
                    <div id="ugqItemsContainer">
                        <p class="text-center p-4" data-i18n="profile.ugqNone">You haven't added any custom questions yet.</p>
                    </div>
                </div>
            </section>

            <section id="profile" class="content-section" role="region" aria-labelledby="profile-heading">
                <h2 id="profile-heading" class="text-center" data-i18n="profile.title">My LifeSync Profile</h2>
                <p class="text-center mb-2" data-i18n="profile.subtitle">This is your personal space. Manage your details, track your progress, and control your sharing preferences.</p>
                
                <div id="profileCompletionContainer">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-[var(--accent-teal-bright)]" data-i18n="profile.completionTitle">Profile Completion</span>
                        <span id="profileCompletionPercentageText" class="text-sm font-semibold text-[var(--accent-teal-bright)]">0%</span>
                    </div>
                    <div id="profileCompletionBarContainer" class="progress-bar-container">
                        <div id="profileCompletionBar" class="progress-bar-fill">0%</div>
                    </div>
                    <p id="profileCompletionHint" class="text-xs text-center text-[var(--text-secondary-lavender)]" data-i18n="profile.completionHint">Complete your profile to unlock more insights and features!</p>
                </div>

                <div class="assessment-container max-w-4xl mx-auto">
                    <div class="grid md:grid-cols-3 gap-6 items-start">
                        <div class="md:col-span-1">
                            <div id="profileImagePreviewContainer" class="text-center mb-4">
                                <div id="profileImagePreview" class="profileImagePreviewStyle"> <i class="fas fa-user-circle"></i> </div>
                                <input type="file" id="profileImageUpload" class="hidden" accept="image/*">
                                <button id="uploadProfilePicBtn" class="btn btn-secondary btn-sm mt-2" data-i18n="profile.uploadPicture">Upload Picture</button>
                                <p class="text-xs mt-1" data-i18n="profile.avatarComingSoon">(Avatars coming soon)</p>
                            </div>
                            <h3 id="profileNameDisplay" class="text-center text-lg font-bold">Your Name</h3>
                            <p id="profileEmailDisplay" class="text-center text-sm text-[var(--text-secondary-lavender)]">Email: user@example.com</p>
                            <p id="profileTypeDisplay" class="text-center text-xs" data-i18n="profile.typePermanent">Profile Type: </p>
                            <p id="profileExpiryDisplay" style="display:none;" class="text-center text-xs" data-i18n="profile.expiresOn">Expires on: </p>
                            <div class="mt-3 text-center">
                                <label for="publicProfileToggle" class="flex items-center justify-center text-sm text-[var(--text-secondary-lavender)]">
                                    <input type="checkbox" id="publicProfileToggle" class="form-checkbox h-4 w-4 text-[var(--accent-teal-bright)] rounded mr-2">
                                    <span data-i18n="profile.makePublic">Make Profile Public (to registered users)</span>
                                </label>
                            </div>
                        </div>

                        <div class="md:col-span-2">
                            <form id="coreProfileForm">
                                <div class="profile-section">
                                    <h4 data-i18n="profile.basicInfoTitle">Basic Information</h4>
                                    <div class="grid sm:grid-cols-2 gap-4">
                                        <div class="form-field-group">
                                            <label for="core-profile-dob" data-i18n="profile.dobLabel">Date of Birth:</label>
                                            <input type="date" id="core-profile-dob" name="dob" class="input-field">
                                        </div>
                                        <div class="form-field-group">
                                            <label for="core-profile-gender" data-i18n="profile.genderLabel">Gender:</label>
                                            <select id="core-profile-gender" name="gender" class="input-field">
                                                <option value="" data-i18n="profile.selectOption">Select...</option>
                                                <option value="male" data-i18n="profile.genderMale">Male</option>
                                                <option value="female" data-i18n="profile.genderFemale">Female</option>
                                                <option value="non-binary" data-i18n="profile.genderNonBinary">Non-binary</option>
                                                <option value="other" data-i18n="profile.genderOther">Other</option>
                                                <option value="prefer-not-to-say" data-i18n="profile.genderPreferNot">Prefer not to say</option>
                                            </select>
                                        </div>
                                        <div class="form-field-group">
                                            <label for="core-profile-location" data-i18n="profile.locationLabel">Location (City, Country):</label>
                                            <input type="text" id="core-profile-location" name="location" class="input-field" data-i18n-placeholder="profile.locationPlaceholder" placeholder="e.g., Johannesburg, South Africa">
                                        </div>
                                    </div>
                                </div>
                                <div class="profile-section">
                                    <h4 data-i18n="profile.lifestyleTitle">Lifestyle & Interests</h4>
                                    <div class="form-field-group">
                                        <label for="core-profile-hobbies" data-i18n="profile.hobbiesLabel">Hobbies & Interests (comma-separated):</label>
                                        <input type="text" id="core-profile-hobbies" name="hobbies" class="input-field" data-i18n-placeholder="profile.hobbiesPlaceholder" placeholder="e.g., hiking, reading, coding">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="core-profile-education" data-i18n="profile.educationLabel">Education Level:</label>
                                        <input type="text" id="core-profile-education" name="education" class="input-field" data-i18n-placeholder="profile.educationPlaceholder" placeholder="e.g., Bachelor's Degree in CS">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="core-profile-occupation" data-i18n="profile.occupationLabel">Occupation/Profession:</label>
                                        <input type="text" id="core-profile-occupation" name="occupation" class="input-field" data-i18n-placeholder="profile.occupationPlaceholder" placeholder="e.g., Software Developer">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="core-profile-about" data-i18n="profile.aboutMeLabel">About Me (Short Bio):</label>
                                        <textarea id="core-profile-about" name="about" rows="3" class="input-field" data-i18n-placeholder="profile.aboutMePlaceholder" placeholder="Tell us a bit about yourself..."></textarea>
                                    </div>
                                </div>
                                <button type="submit" id="saveCoreProfileBtn" class="btn btn-primary w-full" data-i18n="profile.saveProfileBtn">Save Profile Details</button>
                            </form>
                        </div>
                    </div>

                    <div class="mt-6">
                        <h4 data-i18n="profile.assessmentsTitle">Completed Assessments:</h4>
                        <ul id="completedAssessmentsList" class="list-disc pl-5 text-sm"></ul>
                    </div>
                    <div class="mt-4">
                        <h4 data-i18n="profile.partnersTitle">Synced Partners:</h4>
                        <p class="text-sm" id="syncedPartnersDisplay" data-i18n="profile.noPartners">No partner synced yet.</p>
                        <button class="btn btn-purple mt-2 btn-sm" data-target="sync" id="connectPartnerProfileBtn" data-i18n="profile.connectBtn">Connect with Partner</button>
                    </div>
                    <div class="mt-6">
                        <h4 data-i18n="profile.dataTitle">Assessment Profile Data & Preferences:</h4>
                        <div id="profileDataDisplay" class="text-sm"></div>
                        <p class="text-xs mt-2 italic" data-i18n="profile.dataNote">This section shows data from your completed assessments.</p>
                    </div>
                    
                    <div class="mt-6">
                        <h4 data-i18n="profile.importTitle">Import Your Data:</h4>
                        <div class="mb-4">
                            <p class="text-sm mb-2" data-i18n="profile.importInstructionsSocial">Upload your data file (e.g., LinkedIn ZIP, Facebook JSON) to enhance your profile.</p>
                            <input type="file" id="socialMediaFileInput" accept=".zip,.json" class="input-field">
                            <button class="btn btn-primary mt-2 btn-sm" id="importSocialMediaBtn" data-i18n="profile.importBtnSocial">Import Social/Dating Data</button>
                            <div id="importFeedback" class="mt-2 text-sm"></div>
                        </div>
                        <div>
                            <p class="text-sm mb-2" data-i18n="profile.importInstructionsAI">Use AI to extract info from documents (e.g., CV). Process externally, then upload the generated JSON.</p>
                            <label for="aiDataFileInput" class="block text-sm font-medium text-gray-300" data-i18n="profile.aiUploadLabel">Upload AI-Processed JSON:</label>
                            <input type="file" id="aiDataFileInput" accept=".json" class="input-field">
                            <button class="btn btn-purple mt-2 btn-sm" id="importAIDataBtn" data-i18n="profile.importBtnAI">Import AI Processed Data</button>
                            <p class="text-xs mt-1 italic" data-i18n="profile.aiToolNote">Note: Use tools like Gemini, Grok, etc., to process your documents into a structured JSON first.</p>
                            <div id="aiImportFeedback" class="mt-2 text-sm"></div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="sync" class="content-section" role="region" aria-labelledby="sync-heading">
                <h2 id="sync-heading"><i class="fas fa-link"></i> <span data-i18n="sync.title">Couple Sync</span></h2>
                <p data-i18n="sync.subtitle">Connect with your partner to share insights and grow together. All sharing requires mutual consent.</p>
                <div class="assessment-container">
                    <h3 data-i18n="sync.connectTitle">Connect with Partner</h3>
                    <div class="form-field-group">
                        <label for="partnerUsernameSync" data-i18n="sync.partnerUsernameLabel">Partner's Username:</label>
                        <input type="text" id="partnerUsernameSync" name="partnerUsernameSync" class="input-field" data-i18n-placeholder="sync.partnerUsernamePlaceholder" placeholder="Enter your partner's LifeSync username">
                    </div>
                    <button id="sendSyncRequestBtn" class="btn btn-primary w-full"><i class="fas fa-paper-plane"></i> <span data-i18n="sync.sendRequest">Send Sync Request</span></button>

                    <h4 class="mt-8 mb-2" data-i18n="sync.pendingTitle">Pending Requests</h4>
                    <div id="pendingRequestsList"><p data-i18n="sync.noPending">No pending requests.</p></div>

                    <h4 class="mt-8 mb-2" data-i18n="sync.syncedTitle">Synced Partners</h4>
                    <div id="syncedPartnersList"><p data-i18n="sync.noSynced">You are not synced with any partners yet.</p></div>
                </div>
            </section>

        </div> </div> <div id="notificationsArea" class="notifications-area" role="alert" aria-live="polite">
        </div>
    <button id="globalSearchTriggerBtn" class="btn" title="Search LifeSync" aria-label="Search LifeSync"><i class="fas fa-search"></i></button>

    <footer>
        &copy; <span id="currentYearFooter"></span> Salatiso Lonwabo Mdeni - Father, OHS & Risk Expert, Author. All Rights Reserved. |&nbsp;
        <a href="#" data-i18n="footer.privacy">Privacy Policy</a> |&nbsp;
        <a href="#" data-i18n="footer.terms">Terms of Service</a> |&nbsp;
        <span data-i18n="footer.built">Built with <i class="fa-solid fa-heart" style="color: var(--accent-pink-vibrant)"></i> for LifeSync.</span>
    </footer>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2><i class="fa-solid fa-sign-in-alt mr-2" style="color:var(--accent-purple-medium)"></i> <span data-i18n="login.title">Login to LifeSync</span></h2>
            <p class="text-sm mb-4" data-i18n="login.subtitle">Access your profile, assessments, and synced data.</p>
            <form id="loginForm">
                <div class="form-field-group"> <label for="loginEmail" data-i18n="login.emailLabel">Email:</label> <input type="email" id="loginEmail" class="input-field" data-i18n-placeholder="login.emailPlaceholder" placeholder="your@email.com" required> </div>
                <div class="form-field-group"> <label for="loginPassword" data-i18n="login.passwordLabel">Password:</label> <input type="password" id="loginPassword" class="input-field" data-i18n-placeholder="login.passwordPlaceholder" placeholder="Your password" required> </div>
                <button type="submit" class="btn btn-primary w-full" data-i18n="login.submit">Login</button>
            </form>
            <button class="btn btn-secondary w-full mt-2" id="googleLoginBtn"><i class="fab fa-google mr-2"></i> <span data-i18n="login.google">Login with Google</span></button>
            <div class="mt-4">
                <p class="text-sm" data-i18n="login.tempProfilePrompt">Don't want to sign in? Try LifeSync with a temporary profile:</p>
                <button class="btn btn-purple w-full mt-2" id="createTempProfileFromLoginModalBtn" data-i18n="login.tempProfileBtn">Create Temporary Profile</button>
                <button class="btn btn-purple w-full mt-2" id="loginWithTempProfileModalBtn" data-i18n="login.loginTempProfileBtn">Login with Temporary Code</button>
            </div>
        </div>
    </div>

    <div id="registerModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2><i class="fa-solid fa-user-plus mr-2" style="color:var(--accent-pink-vibrant)"></i> <span data-i18n="register.title">Create Your LifeSync Account</span></h2>
            <p class="text-sm mb-4" data-i18n="register.subtitle">Start building your insightful relationship profile.</p>
            <form id="registerForm">
                <div class="form-field-group"> <label for="registerName" data-i18n="register.nameLabel">Name:</label> <input type="text" id="registerName" class="input-field" data-i18n-placeholder="register.namePlaceholder" placeholder="Your Name" required> </div>
                <div class="form-field-group"> <label for="registerEmail" data-i18n="register.emailLabel">Email:</label> <input type="email" id="registerEmail" class="input-field" data-i18n-placeholder="register.emailPlaceholder" placeholder="your@email.com" required> </div>
                <div class="form-field-group"> <label for="registerPassword" data-i18n="register.passwordLabel">Password:</label> <input type="password" id="registerPassword" class="input-field" data-i18n-placeholder="register.passwordPlaceholder" placeholder="Create a password (min. 6 characters)" required> </div>
                <button type="submit" class="btn btn-secondary w-full" data-i18n="register.submit">Register</button>
            </form>
            <button class="btn btn-secondary w-full mt-2" id="googleRegisterBtn"><i class="fab fa-google mr-2"></i> <span data-i18n="register.google">Register with Google</span></button>
        </div>
    </div>

    <div id="tempProfileModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 data-i18n="tempProfile.title">Create Temporary Profile</h2>
            <p class="text-sm mb-4" data-i18n="tempProfile.subtitle">Create a temporary profile to explore LifeSync for 90 days.</p>
            <form id="tempProfileForm">
                <div class="form-field-group"> <label for="tempUsername" data-i18n="tempProfile.usernameLabel">Username:</label> <input type="text" id="tempUsername" class="input-field" data-i18n-placeholder="tempProfile.usernamePlaceholder" placeholder="Choose a username" required> </div>
                <button type="submit" class="btn btn-primary w-full" data-i18n="tempProfile.createBtn">Create Profile & Get Code</button>
            </form>
            <div id="tempProfileCodeSection" class="mt-4" style="display:none;">
                <p data-i18n="tempProfile.codeInstructions">Your temporary profile has been created! Use this code to log in:</p>
                <p class="text-2xl font-bold my-2 p-2 rounded" id="tempProfileCodeDisplay" style="background-color: var(--bg-content-purple-opaque); user-select:all;"></p>
                <p class="text-xs mt-2" data-i18n="tempProfile.expiryNote">This profile will expire in 90 days. Save your username and code securely!</p>
                <button class="btn btn-secondary mt-3" id="tempProfileGotItBtn" data-i18n="tempProfile.gotItBtn">I've Saved It!</button>
            </div>
        </div>
    </div>

    <div id="tempProfileLoginModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 data-i18n="tempProfileLogin.title">Login with Temporary Profile</h2>
            <form id="tempProfileLoginForm">
                <div class="form-field-group"> <label for="tempLoginUsername" data-i18n="tempProfileLogin.usernameLabel">Username:</label> <input type="text" id="tempLoginUsername" class="input-field" data-i18n-placeholder="tempProfileLogin.usernamePlaceholder" placeholder="Your username" required> </div>
                <div class="form-field-group"> <label for="tempLoginCode" data-i18n="tempProfileLogin.codeLabel">Code:</label> <input type="text" id="tempLoginCode" class="input-field" data-i18n-placeholder="tempProfileLogin.codePlaceholder" placeholder="Your access code" required> </div>
                <button type="submit" class="btn btn-primary w-full" data-i18n="tempProfileLogin.submit">Login</button>
            </form>
        </div>
    </div>
    
    <div id="searchModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 data-i18n="search.title"><i class="fas fa-search mr-2"></i> Search LifeSync</h2>
            <input type="text" id="searchInput" class="input-field" data-i18n-placeholder="search.placeholder" placeholder="Search profiles, assessments, resources...">
            <button class="btn btn-primary w-full mt-3" id="searchSubmitBtn" data-i18n="search.submit">Search</button>
            <div id="searchResults" class="mt-4 max-h-60 overflow-y-auto"></div>
        </div>
    </div>

    <div id="benefitModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="benefitModalTitle" class="text-xl mb-4"></h2>
            <p id="benefitModalDescription" class="text-sm mb-6"></p>
            <button id="benefitModalCloseBtn" class="btn btn-primary w-full" data-i18n="landing.learnMoreClose">Close</button>
        </div>
    </div>

    <script type="module">
        // Firebase SDK imports (Modular v11.x.x)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signOut,
            updateProfile,
            signInAnonymously, // For environments where __initial_auth_token might not be present
            signInWithCustomToken // For environments where __initial_auth_token is present
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            collection, 
            query, 
            where, 
            getDocs,
            serverTimestamp,
            Timestamp, // Import Timestamp
            arrayUnion,
            arrayRemove 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";


        // --- Firebase Configuration & Initialization ---
        // These global variables __firebase_config and __initial_auth_token are expected to be injected by the Canvas environment.
        // For local development or direct deployment outside Canvas, you'd replace this with your actual Firebase config.
        const firebaseConfigFromGlobal = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthTokenFromGlobal = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appIdFromGlobal = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';


        let app;
        let auth;
        let db;
        let storage;
        let firebaseInitialized = false;
        let currentUserId = null; // To store the current user's ID (Firebase UID or temp profile ID)
        let isTempUser = false; // Flag to indicate if the current user is temporary

        try {
            if (firebaseConfigFromGlobal) {
                app = initializeApp(firebaseConfigFromGlobal);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);
                firebaseInitialized = true;
                console.log("Firebase initialized successfully with dynamic config.");

                // Set Firestore log level for debugging if needed
                // import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
                // setLogLevel('debug'); 

            } else {
                console.warn("Firebase configuration not found. Firebase features will be limited.");
                // Display a more user-friendly message on the page if needed
                const body = document.querySelector('body');
                const errorDiv = document.createElement('div');
                errorDiv.textContent = "Service configuration missing. Some features may not be available.";
                errorDiv.style.cssText = "background-color: var(--accent-pink-vibrant); color: var(--text-primary-light); padding: 10px; text-align: center; position: fixed; bottom: 0; width: 100%; z-index: 5000;";
                if(body) body.appendChild(errorDiv);
            }
        } catch (error) {
            console.error("Firebase initialization error:", error);
            const body = document.querySelector('body');
            const errorDiv = document.createElement('div');
            errorDiv.textContent = "Error connecting to services. Some features may not be available.";
            errorDiv.style.cssText = "background-color: var(--accent-pink-vibrant); color: var(--text-primary-light); padding: 10px; text-align: center; position: fixed; bottom: 0; width: 100%; z-index: 5000;";
            if(body) body.appendChild(errorDiv);
        }
        
        // --- i18next Internationalization ---
        const translations = { 
            en: {
                translation: {
                    title: "LifeSync - Deepen Your Connections",
                    nav: { brand: "LifeSync", home: "Home", assessments: "Assessments", tools: "Tools", resources: "Resources", profile: "My Profile", login: "Login", register: "Register", logout: "Logout" },
                    landing: {
                        heroTitle: "Beyond the Swipe: Discover True Compatibility",
                        heroSubtitle: "LifeSync empowers you to understand yourself and what you truly need in any significant relationship. Build your dynamic, lifelong profile, 'Sync Up' for profound connections, and always be ready for your best relationship journey.",
                        heroCta: "Explore Assessments",
                        takeAssessmentCta: "Take an Assessment",
                        benefitsTitle: "Why LifeSync? The Path to Deeper Understanding.",
                        benefitsSubtitle: "LifeSync is more than an app; it's your companion for relationship clarity and growth.",
                        benefit1: { title: "Build Your Lifelong Profile", description: "Create a rich, evolving profile that captures your values, preferences, and experiences – your personal relationship blueprint." },
                        benefit2: { title: "Understand Yourself Deeper", description: "Engage with 150+ culturally aware questions. Gain personalized insights into your needs and compatibility factors." },
                        benefit3: { title: "Ready to 'Sync Up'?", description: "Connect with a partner on a new level. Securely share and compare what truly matters, with full, granular consent." },
                        benefitImport: { title: "Seamless Profile Building", description: "Easily import data from existing social/dating profiles or use AI assistance to extract info from documents like your CV. Spend less time typing, more time connecting." },
                        getStartedTitle: "Ready to Begin Your Journey?",
                        getStartedSubtitle: "Create your free LifeSync profile today and take the first step towards more meaningful connections.",
                        registerNow: "Register Your Profile",
                        loginExisting: "Login",
                        learnMoreClose: "Close"
                    },
                    assessments: { 
                        title: "Discover Your Compatibility",
                        subtitle: "Engage with our assessments to gain valuable insights into your relationship dynamics. Assign weights to what matters most to you!",
                        quickCompat: { 
                            title: "Quick Compatibility Check",
                            description: "A fast way for you and a potential partner to get an initial feel for alignment. Choose your depth!",
                            basicBtn: "Quick Sync (5 Q's)",
                            intermediateBtn: "Deeper Dive (10 Q's)",
                            advancedBtn: "Full Spectrum (15 Q's)",
                            importanceLabel: "Importance (1-5):",
                            progressQuestion: "Question",
                            progressOf: "of",
                            nextBtn: "Next",
                            resultsTitle: "Quick Sync Results!",
                            retryBtn: "Try Another Level",
                            questions: { 
                                q_financial_stability: "How important is financial stability to you?",
                                q_indoors_outdoors: "Do you prefer spending time indoors or outdoors?",
                                q_personal_space: "How often do you need personal space?",
                                q_spontaneity_planning: "Do you value spontaneity or planning more?",
                                q_family_involvement: "How important is family involvement in your relationship?",
                                q_comm_style: "What's your preferred communication style in disagreements?",
                                q_conflict_resolution: "How do you typically approach conflict resolution?",
                                q_social_circle: "Do you prefer a small, close-knit social circle or a large network?",
                                q_travel_preference: "What's your ideal type of vacation?",
                                q_dietary_habits: "Are you adventurous with food or prefer familiar options?",
                                q_long_term_goals: "What are your primary long-term life goals?",
                                q_parenting_style: "If applicable, what's your general view on parenting styles?",
                                q_spirituality: "How important is spirituality or religion in your life?",
                                q_political_views: "How do you approach differing political views in a partner?",
                                q_cultural_background_match: "How important is a similar cultural background in a partner?"
                            },
                            options: { 
                                opt_not_important: "Not important", opt_somewhat_important: "Somewhat important", opt_very_important: "Very important",
                                opt_indoors: "Indoors", opt_outdoors: "Outdoors", opt_both: "Both equally",
                                opt_rarely: "Rarely", opt_sometimes: "Sometimes", opt_often: "Often",
                                opt_spontaneity: "Spontaneity", opt_planning: "Planning",
                                opt_direct: "Direct & Open", opt_indirect: "Indirect & Cautious",
                                opt_discuss_now: "Discuss immediately", opt_cool_off: "Cool off first",
                                opt_small_circle: "Small circle", opt_large_network: "Large network",
                                opt_relaxing: "Relaxing (beach, spa)", opt_adventure: "Adventure (hiking, exploring)",
                                opt_anything: "Eat anything", opt_specific_diet: "Specific diet/preferences",
                                opt_career_focus: "Career focused", opt_family_focus: "Family focused", opt_balance_both: "Balance both",
                                opt_strict: "Strict", opt_lenient: "Lenient", opt_authoritative: "Authoritative (balanced)",
                                opt_very_spiritual: "Very spiritual/religious", opt_somewhat_spiritual: "Somewhat spiritual/religious", opt_not_spiritual: "Not spiritual/religious",
                                opt_similar_views: "Prefer similar views", opt_differences_ok: "Differences are okay/enriching",
                                opt_important_match: "Important match", opt_not_important_match: "Not an important match"
                            },
                            results: { 
                                completed: "You completed the",
                                checkWith: "compatibility check with",
                                answers: "answers"
                            }
                        },
                        profileBuilder: { 
                            title: "My Relationship Profile Builder",
                            description: "Build your detailed LifeSync profile by answering these questions about your views, preferences, lifestyle, and more. This forms the basis for future syncs and deeper insights.",
                            q1: "What is your primary love language for GIVING affection?", 
                            questions: { 
                                "profileBuilder.q_love_language_give": "What is your primary love language for GIVING affection?",
                                "profileBuilder.q_love_language_receive": "What is your primary love language for RECEIVING affection?",
                                "profileBuilder.q_financial_transparency_scale": "On a scale of 1 (not at all) to 5 (very), how important is financial transparency to you in a serious relationship?",
                                "profileBuilder.q_stress_handling": "How do you typically handle stress or difficult emotions?",
                                "profileBuilder.q_family_involvement_expectations": "What are your expectations regarding family involvement (e.g., holidays, major decisions)?",
                                "profileBuilder.q_spiritual_beliefs_match_importance": "How important is it for your partner to share your spiritual or religious beliefs?",
                                "profileBuilder.q_children_stance": "What is your stance on having children?",
                                "profileBuilder.q_past_relationships_discussion": "How do you feel about discussing past relationships with a new partner?",
                                "profileBuilder.q_lobola_view": "What role does 'Lobola' (or similar cultural marriage customs) play in your view of marriage, if any?",
                                "profileBuilder.q_household_responsibilities": "How do you envision division of household responsibilities in a cohabiting relationship?"
                            },
                            options: { 
                                words: "Words of Affirmation", acts: "Acts of Service", gifts: "Receiving Gifts", quality_time: "Quality Time", touch: "Physical Touch",
                                "1": "1 (Not at all)", "2": "2", "3": "3 (Moderately)", "4": "4", "5": "5 (Very)",
                                talk_it_out: "Talk it out", alone_time: "Need alone time", distract_myself: "Distract myself", exercise: "Exercise/Activity",
                                very_involved: "Very involved", moderately_involved: "Moderately involved", minimal_involvement: "Minimal involvement",
                                very_important: "Very important", somewhat_important: "Somewhat important", not_important: "Not important",
                                definitely_want: "Definitely want them", open_to_discussion: "Open to discussion", prefer_not: "Prefer not to have children", undecided: "Undecided",
                                open_book: "Open book, happy to share", some_details_ok: "Some details are okay, if relevant", prefer_not_much: "Prefer not to discuss much",
                                essential_tradition: "Essential tradition", important_cultural: "Important cultural aspect", open_to_modern: "Open to modern interpretations/discussion", not_applicable: "Not applicable/relevant to me",
                                strictly_50_50: "Strictly 50/50", based_on_time_skill: "Based on who has more time/skill", flexible_circumstances: "Flexible, depends on circumstances", outsource_some: "Prefer to outsource some tasks"
                            },
                            importanceLabel: "How crucial is this for you? (1-5):",
                            progressQuestion: "Question", progressOf: "of", nextBtn: "Next Question",
                            resultsTitle: "Profile Section Complete!", results: { 
                                completedWith: "You completed your profile builder with",
                                answers: "answers"
                            },
                            reviewBtn: "Review Answers", viewProfileBtn: "View My Profile"
                        },
                        note: "More in-depth assessments on finances, cultural values (e.g., lobola discussions, family roles), lifestyle, and long-term goals are available once you create your profile and connect with a partner."
                    },
                    tools: { 
                        title: "Relationship Enhancement Tools", 
                        subtitle: "Access a suite of tools designed to foster communication, track progress, and navigate challenges together.",
                        explore: "Explore Resources",
                        communication: {title: "Communication Guides", description: "Structured prompts and guides for discussing sensitive topics like finances, family expectations, and future plans."},
                        milestone: { title: "Milestone & Date Tracker", description: "Log important dates, anniversaries, and relationship milestones. Get reminders and celebrate together." },
                        monitoring: { title: "Parameter Monitoring", description: "Track changes in key relationship aspects (e.g., frequency of affirming words, shared activities) and get gentle nudges." },
                        conflict: { title: "Conflict Resolution Aids", description: "Tools to help navigate disagreements constructively, including structured feedback exchange." },
                        goals: { title: "Shared Goals & Dreams", description: "Define and track progress towards shared aspirations as a couple." },
                        closure: { title: "Relationship Closure (If Needed)", description: "Tools to facilitate a respectful and clear process if a relationship ends." },
                        comingSoon: "Coming Soon" 
                    },
                    resources: { 
                        pageTitle: "Relationship Resources Hub",
                        pageSubtitle: "Explore a curated list of tools, services, and information to support your relationship journey.",
                        wizard: {
                            title: "Resource Discovery Wizard",
                            introTitle: "How to Use This Section",
                            introText: "Use the search bar below to find specific resources, or browse through the categories. Click on a category to see available items. Automated suggestions based on your profile will be available soon!",
                            automatedIntro: "Based on your profile, we might have some suggestions for you (Feature Coming Soon!).",
                            customizeBtn: "Customize Suggestions (Coming Soon)",
                            searchLabel: "Search All Resources:",
                            searchPlaceholder: "e.g., counseling, dating apps...",
                            searchBtn: "Search",
                            browseCategories: "Or Browse Categories:"
                        },
                        backToCategories: "Back to Categories",
                        visitSite: "Visit Site",
                        noItemsInCategory: "No items listed in this category yet.",
                        category: { 
                            dating: "Dating & Meeting Platforms",
                            counseling: "Relationship Counseling & Therapy",
                            communication_guides: "Communication Guides",
                            conflict_resolution_aids: "Conflict Resolution Aids",
                            relationship_closure_tools: "Relationship Closure Tools",
                            emergency: "Emergency Contacts Summary"
                        },
                        datingDesc: { 
                            tinder: "Popular swipe-based dating app for meeting new people.",
                            bumble: "Dating app where women make the first move."
                        },
                        counselingDesc: {
                            famsa: "Family and Marriage Society of SA - Offers counseling and support."
                        },
                        emergencyDesc: {
                            lifeLineSAEmergency: "LifeLine SA: 0861 322 322 (24/7 emotional support and crisis intervention)."
                        }
                    },
                    profile: { 
                        title: "My LifeSync Profile", 
                        subtitle: "This is your personal space. Manage your details, track your progress, and control your sharing preferences.",
                        completionTitle: "Profile Completion",
                        completionHint: "Complete your profile to unlock more insights and features!",
                        uploadPicture: "Upload Picture",
                        avatarComingSoon: "(Avatars coming soon)",
                        makePublic: "Make Profile Public (to registered users)",
                        basicInfoTitle: "Basic Information",
                        dobLabel: "Date of Birth:",
                        genderLabel: "Gender:",
                        selectOption: "Select...",
                        genderMale: "Male", genderFemale: "Female", genderNonBinary: "Non-binary", genderOther: "Other", genderPreferNot: "Prefer not to say",
                        locationLabel: "Location (City, Country):",
                        locationPlaceholder: "e.g., Johannesburg, South Africa",
                        lifestyleTitle: "Lifestyle & Interests",
                        hobbiesLabel: "Hobbies & Interests (comma-separated):",
                        hobbiesPlaceholder: "e.g., hiking, reading, coding",
                        educationLabel: "Education Level:",
                        educationPlaceholder: "e.g., Bachelor's Degree in CS",
                        occupationLabel: "Occupation/Profession:",
                        occupationPlaceholder: "e.g., Software Developer",
                        aboutMeLabel: "About Me (Short Bio):",
                        aboutMePlaceholder: "Tell us a bit about yourself...",
                        saveProfileBtn: "Save Profile Details",
                        assessmentsTitle: "Completed Assessments:", 
                        partnersTitle: "Synced Partners:", 
                        noPartners: "No partner synced yet.", 
                        connectBtn: "Connect with Partner", 
                        dataTitle: "Assessment Profile Data & Preferences:", 
                        dataNote: "This section shows data from your completed assessments.",
                        importTitle: "Import Your Data:", 
                        importInstructionsSocial: "Upload your data file (e.g., LinkedIn ZIP, Facebook JSON) to enhance your profile.", 
                        importBtnSocial: "Import Social/Dating Data",
                        importInstructionsAI: "Use AI to extract info from documents (e.g., CV). Process externally, then upload the generated JSON.",
                        aiUploadLabel: "Upload AI-Processed JSON:",
                        importBtnAI: "Import AI Processed Data",
                        aiToolNote: "Note: Use tools like Gemini, Grok, etc., to process your documents into a structured JSON first.",
                        loadingAssessments: "Loading assessments...", 
                        loadingData: "Loading data...",
                        typePermanent: "Permanent Account", 
                        typeTemporary: "Temporary Profile",
                        emailTemp: "Email: (Temporary Profile - Not Set)",
                        expiresOn: "Expires on:",
                        guestName: "Guest User",
                        guestEmail: "Email: Not logged in",
                        noAssessmentsLoggedIn: "Log in or create a profile to see completed assessments.",
                        noDataLoggedIn: "Log in or create a profile to see your data.",
                        noAssessmentsYet: "No assessments completed yet. Explore the Assessments tab!",
                        noProfileDataYet: "No profile data added yet. Complete assessments or import data.",
                        completedOn: "Completed on",
                        ugqTitle: "My Custom Questions", 
                        ugqTitleLong: "My Questions", 
                        ugqCreateTitle: "Create a New Question",
                        ugqQuestionLabel: "Your Question:",
                        ugqQuestionPlaceholder: "e.g., What's your ideal Sunday?",
                        ugqAnswerLabel: "Your Answer:",
                        ugqAnswerPlaceholder: "e.g., A mix of adventure and relaxation.",
                        ugqCategoryLabel: "Category (Optional):",
                        ugqCategoryPlaceholder: "e.g., Lifestyle, Values",
                        ugqSaveBtn: "Save Question",
                        ugqNone: "You haven't added any custom questions yet."
                    },
                    ugq: { 
                        subtitle: "Create your own questions to explore specific areas of compatibility that matter most to you and your partner.",
                        privateLabel: "Keep this question private (only visible to you and synced partners you share with)",
                        yourQuestionsTitle: "Your Created Questions"
                    },
                    sync: { 
                        title: "Couple Sync",
                        subtitle: "Connect with your partner to share insights and grow together. All sharing requires mutual consent.",
                        connectTitle: "Connect with Partner",
                        partnerUsernameLabel: "Partner's Username:",
                        partnerUsernamePlaceholder: "Enter your partner's LifeSync username",
                        sendRequest: "Send Sync Request",
                        pendingTitle: "Pending Requests",
                        noPending: "No pending requests.",
                        syncedTitle: "Synced Partners",
                        noSynced: "You are not synced with any partners yet."
                    },
                    notifications: { title: "Notifications", welcome: "Welcome to LifeSync! Complete your profile to get started." },
                    footer: { privacy: "Privacy Policy", terms: "Terms of Service", built: "Built with <i class='fa-solid fa-heart' style='color: var(--accent-pink-vibrant)'></i> for LifeSync."},
                    login: { 
                        title: "Login to LifeSync", 
                        subtitle: "Access your profile, assessments, and synced data.",
                        emailLabel: "Email:", emailPlaceholder: "your@email.com",
                        passwordLabel: "Password:", passwordPlaceholder: "Your password",
                        submit: "Login", google: "Login with Google",
                        tempProfilePrompt: "Don't want to sign in? Try LifeSync with a temporary profile:",
                        tempProfileBtn: "Create Temporary Profile", loginTempProfileBtn: "Login with Temporary Code"
                    },
                    register: { 
                        title: "Create Your LifeSync Account",
                        subtitle: "Start building your insightful relationship profile.",
                        nameLabel: "Name:", namePlaceholder: "Your Name",
                        emailLabel: "Email:", emailPlaceholder: "your@email.com",
                        passwordLabel: "Password:", passwordPlaceholder: "Create a password (min. 6 characters)",
                        submit: "Register", google: "Register with Google"
                    },
                    tempProfile: { 
                        title: "Create Temporary Profile",
                        subtitle: "Create a temporary profile to explore LifeSync for 90 days.",
                        usernameLabel: "Username:", usernamePlaceholder: "Choose a username",
                        createBtn: "Create Profile & Get Code",
                        codeInstructions: "Your temporary profile has been created! Use this code to log in:",
                        expiryNote: "This profile will expire in 90 days. Save your username and code securely!",
                        gotItBtn: "I've Saved It!"
                    },
                    tempProfileLogin: { 
                        title: "Login with Temporary Profile",
                        usernameLabel: "Username:", usernamePlaceholder: "Your username",
                        codeLabel: "Code:", codePlaceholder: "Your access code",
                        submit: "Login"
                    },
                    search: { 
                        title: "Search LifeSync",
                        placeholder: "Search profiles, assessments, resources...",
                        submit: "Search",
                        button: "Search" 
                    },
                    alerts: { 
                        selectionNeeded: "Please select an answer to proceed.",
                        loginSuccess: "Logged in successfully! Welcome back.",
                        loginFailed: "Login failed. Please check your email and password.",
                        registerSuccess: "Registered successfully! Please log in to continue.",
                        registerFailed: "Registration failed. The email might already be in use or an error occurred.",
                        tempProfileCreated: "Temporary profile created! Your access code is displayed below. Please save it securely.",
                        tempProfileLoginSuccess: "Logged in with temporary profile successfully!",
                        tempProfileLoginFailed: "Invalid username or code. Please check and try again.",
                        tempProfileExpired: "This temporary profile has expired. Please register for a permanent account.",
                        importSuccess: "Social media data imported successfully! Check your profile.",
                        importFailed: "Failed to import data. Please ensure the file format is correct or try again.",
                        aiImportSuccess: "AI processed data imported successfully!",
                        aiImportFailed: "Failed to import AI processed data. Ensure it's valid JSON from LifeSync AI processing.",
                        logoutSuccess: "Logged out successfully!",
                        selectFileFirst: "Please select a file first before importing.",
                        processingFile: "Processing file...",
                        zipParsingNotImplemented: "ZIP file processing is not fully implemented in this example. Please try a JSON file if available.",
                        unsupportedFileFormat: "Unsupported file format. Please upload a JSON file.",
                        fileReadError: "Error reading the selected file.",
                        noActiveProfileForImport: "No active profile to import data to. Please log in or create a temporary profile first.",
                        loginToImport: "Please log in or create a temporary profile to import data.",
                        ugqSaved: "Your custom question has been saved!",
                        ugqError: "Error saving custom question. Please try again.",
                        ugqFieldsMissing: "Please fill in both the question and your answer.",
                        profileDetailsSaved: "Profile details saved successfully!",
                        profileDetailsError: "Error saving profile details.",
                        imageUploadSuccess: "Profile image uploaded successfully!",
                        imageUploadError: "Error uploading profile image."
                    }
                }
            },
            xh: { /* ... Xhosa translations ... */ },
            zu: { /* ... Zulu translations ... */ },
            af: { /* ... Afrikaans translations ... */ }
            // Add other languages as needed
        };

        i18next
            .use(i18nextBrowserLanguageDetector)
            .init({
                resources: translations,
                fallbackLng: 'en',
                debug: true, 
                interpolation: { escapeValue: false } 
            }, (err, t) => {
                if (err) return console.error('i18next init error:', err);
                updateUIWithTranslations(); 
                initializeDynamicContent(); 
            });

        function updateUIWithTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(elem => {
                const key = elem.getAttribute('data-i18n');
                if (elem.hasAttribute('data-i18n-placeholder')) {
                    const placeholderKey = elem.getAttribute('data-i18n-placeholder');
                    elem.setAttribute('placeholder', i18next.t(placeholderKey));
                }
                if (key) {
                    const translation = i18next.t(key);
                    if (elem.tagName === 'INPUT' && (elem.type === 'submit' || elem.type === 'button')) {
                        elem.value = translation; 
                    } else {
                        elem.innerHTML = translation; 
                    }
                }
            });
            const pageTitleElement = document.querySelector('title[data-i18n]');
            if (pageTitleElement) {
                pageTitleElement.textContent = i18next.t(pageTitleElement.getAttribute('data-i18n'));
            }
        }
        
        document.getElementById('languageSelector').addEventListener('change', function() {
            i18next.changeLanguage(this.value, (err, t) => {
                if (err) return console.error('Error changing language:', err);
                updateUIWithTranslations(); 
                initializeDynamicContent(); 
            });
        });

        // --- Global Variables & DOM Elements ---
        const contentOverlay = document.getElementById('content-overlay'); 
        const allSections = document.querySelectorAll('.content-section');
        const navButtons = document.querySelectorAll('nav .nav-links button[data-target]');
        const brandLinkNav = document.querySelector('nav a.nav-brand[data-target]');
        
        const loginBtnNavEl = document.getElementById('loginBtnNav');
        const registerBtnNavEl = document.getElementById('registerBtnNav');
        const logoutBtnNavEl = document.getElementById('logoutBtnNav');
        const navProfileBtnEl = document.getElementById('navProfileBtn'); 

        const loginModalEl = document.getElementById('loginModal');
        const registerModalEl = document.getElementById('registerModal');
        const tempProfileModalEl = document.getElementById('tempProfileModal');
        const tempProfileLoginModalEl = document.getElementById('tempProfileLoginModal');
        const searchModalEl = document.getElementById('searchModal');
        const benefitModalEl = document.getElementById('benefitModal');
        const benefitModalTitleEl = document.getElementById('benefitModalTitle');
        const benefitModalDescriptionEl = document.getElementById('benefitModalDescription');
        
        const currentYearFooterEl = document.getElementById('currentYearFooter');
        if(currentYearFooterEl) currentYearFooterEl.textContent = new Date().getFullYear();

        const loadingOverlay = document.getElementById('loadingOverlay');

        // --- Utility Functions ---
        function showLoading(show) {
            if (loadingOverlay) loadingOverlay.style.display = show ? 'flex' : 'none';
        }

        function sanitizeInput(input) { 
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }
        
        // --- Navigation & Section Handling ---
        function showSection(targetId) {
            console.log("Attempting to show section:", targetId);
            let foundTarget = false;
            allSections.forEach(section => {
                if (section.id === targetId) {
                    section.classList.add('active-section');
                    foundTarget = true;
                } else {
                    section.classList.remove('active-section');
                }
            });

            const targetSection = document.getElementById(targetId);

            if (targetSection && contentOverlay) {
                contentOverlay.style.scrollBehavior = 'auto';
                contentOverlay.scrollLeft = targetSection.offsetLeft;
                setTimeout(() => {
                    contentOverlay.style.scrollBehavior = 'smooth';
                }, 0);
            } else {
                console.error("Target section not found or contentOverlay missing for scroll:", targetId);
                const aboutSection = document.getElementById('about');
                if(aboutSection) {
                    allSections.forEach(s => s.classList.remove('active-section'));
                    aboutSection.classList.add('active-section');
                    if (contentOverlay) contentOverlay.scrollLeft = 0; 
                }
            }
            
            navButtons.forEach(btn => {
                btn.classList.remove('active-nav');
                if (btn.getAttribute('data-target') === targetId) {
                    btn.classList.add('active-nav');
                } else if (!foundTarget && btn.getAttribute('data-target') === 'about') { 
                    btn.classList.add('active-nav');
                }
            });
            
            if (targetId === 'resources') initializeResourceSection();
            if (targetId === 'assessments') initializeAssessmentSection();
            if (targetId === 'profile' || targetId === 'ugq') updateProfileDisplay(); 
        }

        navButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const targetId = e.currentTarget.getAttribute('data-target');
                if(targetId) showSection(targetId);
            });
        });

        if(brandLinkNav) {
            brandLinkNav.addEventListener('click', (e) => {
                e.preventDefault();
                showSection('about');
            });
        }
        document.querySelectorAll('#about .btn[data-target]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const targetId = e.currentTarget.getAttribute('data-target');
                if(targetId) showSection(targetId);
            });
        });
        document.getElementById('registerBtnLanding')?.addEventListener('click', () => showModal('registerModal'));
        document.getElementById('loginBtnLanding')?.addEventListener('click', () => showModal('loginModal'));
        document.getElementById('viewProfileFromAssessment')?.addEventListener('click', () => showSection('profile'));
        document.getElementById('connectPartnerProfileBtn')?.addEventListener('click', () => showSection('sync'));


        function updateActiveNavButtonOnScroll() {
            if (!contentOverlay) return;
            const scrollLeft = contentOverlay.scrollLeft;
            const overlayWidth = contentOverlay.offsetWidth; 

            let mostVisibleSection = null;
            let maxVisibility = 0;

            allSections.forEach(section => {
                if (section.classList.contains('active-section')) { 
                    const sectionLeft = section.offsetLeft;
                    const sectionWidth = section.offsetWidth;
                    
                    const visibleStart = Math.max(sectionLeft, scrollLeft);
                    const visibleEnd = Math.min(sectionLeft + sectionWidth, scrollLeft + overlayWidth);
                    const visibleWidth = Math.max(0, visibleEnd - visibleStart);
                    
                    if (visibleWidth > maxVisibility) { 
                        maxVisibility = visibleWidth;
                        mostVisibleSection = section;
                    }
                }
            });
            
            if (mostVisibleSection) {
                navButtons.forEach(btn => {
                    btn.classList.remove('active-nav');
                    if (btn.getAttribute('data-target') === mostVisibleSection.id) {
                        btn.classList.add('active-nav');
                    }
                });
            }
        }

        if(contentOverlay) {
            contentOverlay.addEventListener('scroll', updateActiveNavButtonOnScroll);
        }
        
        // --- Benefit Card Click Logic ---
        const benefitCards = document.querySelectorAll('#about .benefit-card');
        benefitCards.forEach(card => {
            card.addEventListener('click', () => {
                const benefitId = card.dataset.benefitId;
                handleBenefitCardClick(benefitId);
            });
        });

        function handleBenefitCardClick(benefitId) {
            if (!benefitModalEl || !benefitModalTitleEl || !benefitModalDescriptionEl) return;
            
            const titleKey = `landing.${benefitId}.title`;
            const descriptionKey = `landing.${benefitId}.description`;

            benefitModalTitleEl.textContent = i18next.t(titleKey, {defaultValue: "Benefit Details"});
            benefitModalDescriptionEl.textContent = i18next.t(descriptionKey, {defaultValue: "More information about this benefit will be available here."}); 
            
            showModal('benefitModal');
        }
        
        // --- Modal Management ---
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if(modal) modal.classList.add('active');
        }
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if(modal) modal.classList.remove('active');
        }
        function closeAllModals() {
            document.querySelectorAll('.modal.active').forEach(modal => modal.classList.remove('active'));
        }

        document.querySelectorAll('.modal .close-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const modal = e.target.closest('.modal');
                if(modal) closeModal(modal.id);
            });
        });
        
        document.getElementById('benefitModalCloseBtn')?.addEventListener('click', () => closeModal('benefitModal'));

        window.addEventListener('click', (event) => {
            document.querySelectorAll('.modal.active').forEach(modal => {
                if (event.target == modal) {
                    closeModal(modal.id);
                }
            });
        });
        
        loginBtnNavEl?.addEventListener('click', () => showModal('loginModal'));
        registerBtnNavEl?.addEventListener('click', () => showModal('registerModal'));
        document.getElementById('createTempProfileFromLoginModalBtn')?.addEventListener('click', () => { closeModal('loginModal'); showModal('tempProfileModal'); });
        document.getElementById('loginWithTempProfileModalBtn')?.addEventListener('click', () => { closeModal('loginModal'); showModal('tempProfileLoginModal'); });
        document.getElementById('globalSearchTriggerBtn')?.addEventListener('click', () => showModal('searchModal'));
        document.getElementById('tempProfileGotItBtn')?.addEventListener('click', () => closeModal('tempProfileModal'));

        // --- Notifications ---
        const notificationsAreaEl = document.getElementById('notificationsArea');
        function showNotification(message, type = 'info', duration = 5000) {
            if (!notificationsAreaEl) { console.warn("Notifications area not found"); return; }
            const notification = document.createElement('div');
            notification.className = `notification-item ${type}`;
            notification.textContent = message;
            notificationsAreaEl.appendChild(notification);
            setTimeout(() => {
                notification.style.animation = 'slideOutNotification 0.5s forwards'; 
                setTimeout(() => notification.remove(), 500);
            }, duration);
        }

        // --- Authentication Logic ---
        function updateUIForLoggedOutUser() {
            loginBtnNavEl.style.display = 'inline-block';
            registerBtnNavEl.style.display = 'inline-block';
            logoutBtnNavEl.style.display = 'none';
            navProfileBtnEl.style.display = 'none';
            navProfileBtnEl.innerHTML = `<i class="fa-solid fa-user-edit"></i> <span data-i18n="nav.profile">${i18next.t('nav.profile')}</span>`;
            currentUserId = null;
            isTempUser = false;
            updateProfileDisplay(); // Update profile section for logged-out state
        }

        function updateUIForTempUser(tempProfile) {
            loginBtnNavEl.style.display = 'none';
            registerBtnNavEl.style.display = 'none';
            logoutBtnNavEl.style.display = 'inline-block'; 
            navProfileBtnEl.style.display = 'inline-block';
            navProfileBtnEl.innerHTML = `<i class="fa-solid fa-user-clock"></i> ${tempProfile.username || i18next.t('nav.profile')}`;
            currentUserId = tempProfile.id; // Store temp profile ID
            isTempUser = true;
            updateProfileDisplay(); // Update profile section for temp user
        }


        if (firebaseInitialized && auth) {
            // Initial auth attempt with custom token or anonymous sign-in
            (async () => {
                try {
                    if (initialAuthTokenFromGlobal) {
                        await signInWithCustomToken(auth, initialAuthTokenFromGlobal);
                        console.log("Successfully signed in with custom token.");
                    } else {
                        // Fallback to anonymous sign-in if no custom token is provided
                        // This is useful for environments where user-specific tokens aren't immediately available
                        // but you still want Firebase to operate (e.g., for public data access or delayed auth)
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously as __initial_auth_token was not available.");
                    }
                } catch (error) {
                    console.error("Error during initial sign-in (custom token or anonymous):", error);
                    // If initial sign-in fails, the onAuthStateChanged listener will still handle the 'null' user state.
                }
            })();


            onAuthStateChanged(auth, user => {
                showLoading(true);
                console.log("Auth state changed. Firebase User:", user ? user.uid : "null");
                const tempProfile = JSON.parse(localStorage.getItem('tempProfile')); 

                if (user) { 
                    loginBtnNavEl.style.display = 'none';
                    registerBtnNavEl.style.display = 'none';
                    logoutBtnNavEl.style.display = 'inline-block';
                    navProfileBtnEl.style.display = 'inline-block';
                    navProfileBtnEl.innerHTML = `<i class="fa-solid fa-user-circle"></i> ${user.displayName || i18next.t('nav.profile')}`;
                    localStorage.removeItem('tempProfile'); 
                    currentUserId = user.uid; // Store Firebase UID
                    isTempUser = false;
                    closeAllModals();
                } else if (tempProfile && tempProfile.id && tempProfile.expiresAt && new Date(tempProfile.expiresAt) > new Date()) { 
                    updateUIForTempUser(tempProfile);
                } else { 
                    updateUIForLoggedOutUser();
                    if (tempProfile) localStorage.removeItem('tempProfile'); 
                }
                updateProfileDisplay(); 
                initializeDynamicContent(); 
                showLoading(false);
            });
        } else {
            console.warn("Firebase Auth not initialized. Auth features will be limited.");
            updateUIForLoggedOutUser(); 
            showLoading(false);
        }

        document.getElementById('loginForm')?.addEventListener('submit', async e => {
            e.preventDefault();
            if (!firebaseInitialized || !auth) { showNotification("Service not available.", "error"); return; }
            showLoading(true);
            const email = sanitizeInput(document.getElementById('loginEmail').value);
            const password = document.getElementById('loginPassword').value; 
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showNotification(i18next.t('alerts.loginSuccess'), 'success');
                closeModal('loginModal');
            } catch (err) {
                showNotification(i18next.t('alerts.loginFailed') + ` ${err.message}`, 'error');
            } finally {
                showLoading(false);
            }
        });

        async function handleGoogleAuth(isRegistering = false) {
            if (!firebaseInitialized || !auth || !db) { showNotification("Service not available.", "error"); return; }
            showLoading(true);
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                const message = result.additionalUserInfo?.isNewUser || isRegistering ? i18next.t('alerts.registerSuccess') : i18next.t('alerts.loginSuccess');
                showNotification(message, 'success');
                
                if ((result.additionalUserInfo?.isNewUser || isRegistering)) {
                    const userDocRef = doc(db, `artifacts/${appIdFromGlobal}/users/${user.uid}`);
                    await setDoc(userDocRef, {
                        name: user.displayName, 
                        email: user.email, 
                        username: user.email, 
                        createdAt: serverTimestamp(),
                        coreProfile: { name: user.displayName, email: user.email }, 
                        assessments: [], 
                        profileData: {}, 
                        userGeneratedQuestions: [],
                        isPublic: false 
                    }, { merge: true });
                }
                closeAllModals();
            } catch (err) {
                showNotification(i18next.t('alerts.loginFailed') + ` ${err.code} - ${err.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        document.getElementById('googleLoginBtn')?.addEventListener('click', () => handleGoogleAuth(false));
        document.getElementById('googleRegisterBtn')?.addEventListener('click', () => handleGoogleAuth(true));

        document.getElementById('registerForm')?.addEventListener('submit', async e => {
            e.preventDefault();
            if (!firebaseInitialized || !auth || !db) { showNotification("Service not available.", "error"); return; }
            showLoading(true);
            const name = sanitizeInput(document.getElementById('registerName').value);
            const email = sanitizeInput(document.getElementById('registerEmail').value);
            const password = document.getElementById('registerPassword').value;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: name });
                
                const userDocRef = doc(db, `artifacts/${appIdFromGlobal}/users/${userCredential.user.uid}`);
                await setDoc(userDocRef, {
                    name: name, 
                    email: email, 
                    username: email, 
                    createdAt: serverTimestamp(),
                    coreProfile: { name: name, email: email }, 
                    assessments: [], 
                    profileData: {}, 
                    userGeneratedQuestions: [],
                    isPublic: false
                });
                showNotification(i18next.t('alerts.registerSuccess'), 'success');
                closeModal('registerModal');
            } catch (err) {
                showNotification(i18next.t('alerts.registerFailed') + ` ${err.message}`, 'error');
            } finally {
                showLoading(false);
            }
        });

        logoutBtnNavEl?.addEventListener('click', async () => {
            if (!firebaseInitialized || !auth) { showNotification("Service not available.", "error"); return; }
            showLoading(true);
            try {
                if (auth.currentUser) {
                    await signOut(auth);
                } else if (localStorage.getItem('tempProfile')) { 
                    localStorage.removeItem('tempProfile');
                     // Manually trigger UI update for logged-out state as onAuthStateChanged might not fire if already null
                    updateUIForLoggedOutUser();
                    showNotification(i18next.t('alerts.logoutSuccess'), 'info');
                    showSection('about'); // Navigate to home after temp logout
                }
            } catch (error) {
                console.error("Sign out error", error);
                showNotification("Error signing out: " + error.message, "error");
            } finally {
                showLoading(false);
                // onAuthStateChanged will handle UI updates for Firebase users
                // For temp users, if not handled by onAuthStateChanged (if it doesn't fire for this case), ensure UI is reset
                if (!auth.currentUser && !localStorage.getItem('tempProfile')) {
                    updateUIForLoggedOutUser();
                    showSection('about');
                }
            }
        });

        document.getElementById('tempProfileForm')?.addEventListener('submit', async e => {
            e.preventDefault();
            if (!firebaseInitialized || !db) { showNotification("Service not available.", "error"); return; }
            showLoading(true);
            const username = sanitizeInput(document.getElementById('tempUsername').value.trim());
            if (!username) { showNotification("Please enter a username.", 'error'); showLoading(false); return; }
            
            const code = Math.random().toString(36).substring(2, 10).toUpperCase();
            const expiresAtDate = new Date(); expiresAtDate.setDate(expiresAtDate.getDate() + 90);

            const tempProfilesCol = collection(db, `artifacts/${appIdFromGlobal}/public/data/tempProfiles`);
            const q = query(tempProfilesCol, where('username', '==', username));
            
            try {
                const snapshot = await getDocs(q);
                if (!snapshot.empty) { 
                    showNotification("Username already taken. Please choose another one.", 'error'); 
                    showLoading(false); 
                    return; 
                }
                
                const docRef = await addDoc(tempProfilesCol, {
                    username: username, 
                    code: code, 
                    createdAt: serverTimestamp(),
                    expiresAt: Timestamp.fromDate(expiresAtDate), // Use Timestamp for Firestore
                    coreProfile: { name: username }, 
                    assessments: [], 
                    profileData: {}, 
                    userGeneratedQuestions: []
                });

                const tempProfileDetails = { username: username, code: code, id: docRef.id, expiresAt: expiresAtDate.toISOString() };
                localStorage.setItem('tempProfile', JSON.stringify(tempProfileDetails));
                document.getElementById('tempProfileCodeDisplay').textContent = code;
                document.getElementById('tempProfileCodeSection').style.display = 'block';
                document.getElementById('tempProfileForm').style.display = 'none';
                showNotification(i18next.t('alerts.tempProfileCreated'), 'success');
                updateUIForTempUser(tempProfileDetails); // Manually update UI for temp user
                closeModal('tempProfileModal'); // Close the creation modal
                showSection('profile'); // Navigate to profile

            } catch (err) {
                showNotification("Error creating temporary profile: " + err.message, 'error');
            } finally {
                showLoading(false);
            }
        });

        document.getElementById('tempProfileLoginForm')?.addEventListener('submit', async e => {
            e.preventDefault();
            if (!firebaseInitialized || !db) { showNotification("Service not available.", "error"); return; }
            showLoading(true);
            const username = sanitizeInput(document.getElementById('tempLoginUsername').value.trim());
            const code = sanitizeInput(document.getElementById('tempLoginCode').value.trim());

            const tempProfilesCol = collection(db, `artifacts/${appIdFromGlobal}/public/data/tempProfiles`);
            const q = query(tempProfilesCol, where('username', '==', username), where('code', '==', code));

            try {
                const snapshot = await getDocs(q);
                if (snapshot.empty) throw new Error(i18next.t('alerts.tempProfileLoginFailed'));
                
                let foundProfile = null, profileId = null;
                snapshot.forEach(docSnap => { // Firestore returns QuerySnapshot, iterate docs
                     foundProfile = docSnap.data(); profileId = docSnap.id; 
                });

                if (!foundProfile) throw new Error(i18next.t('alerts.tempProfileLoginFailed')); // Should be caught by empty snapshot
                
                if (foundProfile.expiresAt.toDate() < new Date()) {
                    await deleteDoc(doc(db, `artifacts/${appIdFromGlobal}/public/data/tempProfiles`, profileId)); 
                    localStorage.removeItem('tempProfile');
                    throw new Error(i18next.t('alerts.tempProfileExpired'));
                }
                const tempProfileDetails = { username: username, code: code, id: profileId, expiresAt: foundProfile.expiresAt.toDate().toISOString() };
                localStorage.setItem('tempProfile', JSON.stringify(tempProfileDetails));
                showNotification(i18next.t('alerts.tempProfileLoginSuccess'), 'success');
                closeModal('tempProfileLoginModal');
                updateUIForTempUser(tempProfileDetails); // Manually update UI
                showSection('profile');
            } catch (err) {
                showNotification(err.message, 'error');
            } finally {
                showLoading(false);
            }
        });

        // --- Profile Section Logic ---
        const profileImagePreviewEl = document.getElementById('profileImagePreview');
        const profileImageUploadEl = document.getElementById('profileImageUpload');
        const coreProfileFormEl = document.getElementById('coreProfileForm');
        const publicProfileToggleEl = document.getElementById('publicProfileToggle');

        document.getElementById('uploadProfilePicBtn')?.addEventListener('click', () => {
            profileImageUploadEl?.click();
        });
        
        profileImageUploadEl?.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (file && firebaseInitialized && storage && currentUserId) {
                showLoading(true);
                const filePath = `artifacts/${appIdFromGlobal}/users/${currentUserId}/profileImages/${file.name}`;
                const storageRef = ref(storage, filePath);
                try {
                    const snapshot = await uploadBytes(storageRef, file);
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    
                    profileImagePreviewEl.innerHTML = `<img src="${downloadURL}" alt="Profile Preview" class="profileImagePreviewStyle">`;
                    
                    const profileRef = getProfileRef();
                    if (profileRef) {
                        await updateDoc(profileRef, { "coreProfile.profileImageUrl": downloadURL });
                    }
                    showNotification(i18next.t('alerts.imageUploadSuccess'), 'success');
                } catch (error) {
                    console.error("Error uploading image: ", error);
                    showNotification(i18next.t('alerts.imageUploadError') + ` ${error.message}`, 'error');
                } finally {
                    showLoading(false);
                }
            } else if (!currentUserId) {
                showNotification("Please log in or create a profile to upload an image.", "error");
            }
        });
        
        function getProfileRef() {
            if (!firebaseInitialized || !db) return null;
            // currentUserId is now set by auth state changes or temp profile login
            if (currentUserId) {
                const collectionPath = isTempUser ? 
                    `artifacts/${appIdFromGlobal}/public/data/tempProfiles` : 
                    `artifacts/${appIdFromGlobal}/users`;
                return doc(db, collectionPath, currentUserId);
            }
            return null;
        }

        coreProfileFormEl?.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!firebaseInitialized) { showNotification("Service not available.", "error"); return; }
            showLoading(true);
            const profileRef = getProfileRef();
            if (!profileRef) { showNotification("No active profile to save details to.", "error"); showLoading(false); return; }

            const coreProfileData = {
                dob: document.getElementById('core-profile-dob').value,
                gender: document.getElementById('core-profile-gender').value,
                location: sanitizeInput(document.getElementById('core-profile-location').value.trim()),
                hobbies: sanitizeInput(document.getElementById('core-profile-hobbies').value.trim()),
                education: sanitizeInput(document.getElementById('core-profile-education').value.trim()),
                occupation: sanitizeInput(document.getElementById('core-profile-occupation').value.trim()),
                about: sanitizeInput(document.getElementById('core-profile-about').value.trim()),
            };
            
            const firebaseUser = auth?.currentUser;
            if(firebaseUser && !isTempUser) {
                coreProfileData.name = firebaseUser.displayName || document.getElementById('registerName')?.value || 'User'; 
                coreProfileData.email = firebaseUser.email;
            } else if (isTempUser) {
                 const tempProfileLocal = JSON.parse(localStorage.getItem('tempProfile'));
                 coreProfileData.name = tempProfileLocal?.username || 'Guest';
            }
            
            const updateData = { 
                coreProfile: coreProfileData,
                updatedAt: serverTimestamp() 
            };
            if (!isTempUser) { // Only permanent users have isPublic toggle
                updateData.isPublic = publicProfileToggleEl ? publicProfileToggleEl.checked : false;
                updateData.name = coreProfileData.name; 
            }


            try {
                await setDoc(profileRef, updateData , { merge: true });
                showNotification(i18next.t('alerts.profileDetailsSaved'), 'success');
                calculateProfileCompletion(coreProfileData);
                if (firebaseUser && !isTempUser && firebaseUser.displayName !== coreProfileData.name) { // Update Firebase Auth profile name if changed
                    await updateProfile(firebaseUser, { displayName: coreProfileData.name });
                }
                updateProfileDisplay(); // Refresh display
            } catch (error) {
                console.error("Error saving profile details:", error);
                showNotification(i18next.t('alerts.profileDetailsError') + ` ${error.message}`, 'error');
            }
            showLoading(false);
        });
        
        function calculateProfileCompletion(coreProfile = {}) {
            const bar = document.getElementById('profileCompletionBar');
            const textEl = document.getElementById('profileCompletionPercentageText');
            if (!bar || !textEl) return;

            const fields = ['dob', 'gender', 'location', 'hobbies', 'education', 'occupation', 'about'];
            let filledFields = 0;
            const totalFields = fields.length;

            fields.forEach(field => {
                if (coreProfile[field] && String(coreProfile[field]).trim() !== '') {
                    filledFields++;
                }
            });
            const completionPercentage = totalFields > 0 ? Math.round((filledFields / totalFields) * 100) : 0;
            bar.style.width = `${completionPercentage}%`;
            bar.textContent = `${completionPercentage}%`;
            textEl.textContent = `${completionPercentage}%`;
            document.getElementById('profileCompletionHint').textContent = completionPercentage < 70 ? i18next.t('profile.completionHint') : "Your profile is looking great!";
        }

        async function updateProfileDisplay() {
            const nameEl = document.getElementById('profileNameDisplay');
            const emailEl = document.getElementById('profileEmailDisplay');
            const typeEl = document.getElementById('profileTypeDisplay');
            const expiryEl = document.getElementById('profileExpiryDisplay');
            const assessmentsListEl = document.getElementById('completedAssessmentsList');
            const dataDisplayEl = document.getElementById('profileDataDisplay');
            const ugqContainerEl = document.getElementById('ugqItemsContainer'); 
            const profileImagePreview = document.getElementById('profileImagePreview');

            // Reset to guest state initially
            if(nameEl) nameEl.textContent = i18next.t('profile.guestName');
            if(emailEl) emailEl.textContent = i18next.t('profile.guestEmail');
            if(typeEl) typeEl.textContent = "";
            if(expiryEl) expiryEl.style.display = 'none';
            if(assessmentsListEl) assessmentsListEl.innerHTML = `<li>${i18next.t('profile.noAssessmentsLoggedIn')}</li>`;
            if(dataDisplayEl) dataDisplayEl.innerHTML = `<p>${i18next.t('profile.noDataLoggedIn')}</p>`;
            if(ugqContainerEl) ugqContainerEl.innerHTML = `<p class="text-center p-4">${i18next.t('profile.ugqNone')}</p>`;
            if(profileImagePreview) profileImagePreview.innerHTML = `<i class="fas fa-user-circle"></i>`;
            calculateProfileCompletion({}); 

            if (!firebaseInitialized) {
                showLoading(false);
                return;
            }
            showLoading(true);
            const profileRef = getProfileRef(); // Uses currentUserId and isTempUser

            if (!profileRef) { 
                showLoading(false); 
                // UI should already reflect logged-out state from onAuthStateChanged
                return; 
            }

            try {
                const docSnap = await getDoc(profileRef);
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    const coreProfile = userData.coreProfile || {};
                    
                    if(nameEl) nameEl.textContent = coreProfile.name || (auth?.currentUser && !isTempUser ? auth.currentUser.displayName : userData.username || 'User');
                    if(emailEl && auth?.currentUser && !isTempUser) emailEl.textContent = `Email: ${auth.currentUser.email}`;
                    else if (emailEl && isTempUser) emailEl.textContent = i18next.t('profile.emailTemp');

                    if(typeEl) typeEl.textContent = (auth?.currentUser && !isTempUser) ? i18next.t('profile.typePermanent') : i18next.t('profile.typeTemporary');
                    if(expiryEl && isTempUser && userData.expiresAt) {
                        expiryEl.textContent = `${i18next.t('profile.expiresOn')} ${userData.expiresAt.toDate().toLocaleDateString()}`;
                        expiryEl.style.display = 'block';
                    } else if(expiryEl) {
                        expiryEl.style.display = 'none';
                    }

                    if(coreProfileFormEl) {
                        document.getElementById('core-profile-dob').value = coreProfile.dob || '';
                        document.getElementById('core-profile-gender').value = coreProfile.gender || '';
                        document.getElementById('core-profile-location').value = coreProfile.location || '';
                        document.getElementById('core-profile-hobbies').value = coreProfile.hobbies || '';
                        document.getElementById('core-profile-education').value = coreProfile.education || '';
                        document.getElementById('core-profile-occupation').value = coreProfile.occupation || '';
                        document.getElementById('core-profile-about').value = coreProfile.about || '';
                        if(publicProfileToggleEl && !isTempUser) publicProfileToggleEl.checked = userData.isPublic || false;
                        else if (publicProfileToggleEl && isTempUser) publicProfileToggleEl.style.display = 'none'; // Hide for temp users
                    }
                    if (profileImagePreview && coreProfile.profileImageUrl) {
                        profileImagePreview.innerHTML = `<img src="${coreProfile.profileImageUrl}" alt="Profile Preview" class="profileImagePreviewStyle">`;
                    } else if (profileImagePreview) {
                         profileImagePreview.innerHTML = `<i class="fas fa-user-circle"></i>`;
                    }

                    calculateProfileCompletion(coreProfile);
                    
                    renderAssessmentsList(userData.assessments || [], assessmentsListEl);
                    renderProfileAssessmentData(userData.profileData || {}, dataDisplayEl); 
                    renderUserGeneratedQuestionsList(userData.userGeneratedQuestions || [], ugqContainerEl, true); 
                } else {
                    // If doc doesn't exist but user is authenticated (e.g. new user via Google before doc creation)
                    if (auth?.currentUser && !isTempUser && nameEl) nameEl.textContent = auth.currentUser.displayName || 'User';
                    if (auth?.currentUser && !isTempUser && emailEl) emailEl.textContent = `Email: ${auth.currentUser.email}`;
                }
            } catch (error) {
                console.error("Error fetching profile data for display:", error);
                showNotification("Error loading profile information.", "error");
            }
            showLoading(false);
        }
        
        function renderAssessmentsList(assessments = [], listEl) {
            if (!listEl) return;
            listEl.innerHTML = '';
            if (assessments.length === 0) {
                listEl.innerHTML = `<li>${i18next.t('profile.noAssessmentsYet')}</li>`;
                return;
            }
            assessments.forEach(asm => {
                const li = document.createElement('li');
                const completedDate = asm.completedAt?.toDate ? new Date(asm.completedAt.toDate()).toLocaleDateString() : new Date(asm.completedAt).toLocaleDateString(); // Handle both Timestamp and ISO string
                li.textContent = `${asm.name || 'Assessment'} - ${i18next.t('profile.completedOn')} ${completedDate}`;
                listEl.appendChild(li);
            });
        }

        function renderProfileAssessmentData(profileData = {}, displayEl) {
            if (!displayEl) return;
            displayEl.innerHTML = ''; 
            if (Object.keys(profileData).length === 0) {
                displayEl.innerHTML = `<p>${i18next.t('profile.noProfileDataYet')}</p>`;
                return;
            }
            const ul = document.createElement('ul');
            for (const key in profileData) {
                if (profileData.hasOwnProperty(key)) {
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>${sanitizeInput(key.replace(/_/g, ' '))}:</strong> ${sanitizeInput(JSON.stringify(profileData[key]))}`;
                    ul.appendChild(li);
                }
            }
            displayEl.appendChild(ul);
        }

        // --- Assessment Logic ---
        let currentQuickCompatQuizData = { questions: [], level: 'basic' }; 
        let currentQuickCompatIndex = 0;
        let quickCompatUserAnswers = []; 
        const quickCompatQuestionSets = { 
            basic: ['assessments.quickCompat.questions.q_financial_stability', 'assessments.quickCompat.questions.q_indoors_outdoors', 'assessments.quickCompat.questions.q_personal_space', 'assessments.quickCompat.questions.q_spontaneity_planning', 'assessments.quickCompat.questions.q_family_involvement'],
            intermediate: ['assessments.quickCompat.questions.q_financial_stability', 'assessments.quickCompat.questions.q_indoors_outdoors', 'assessments.quickCompat.questions.q_personal_space', 'assessments.quickCompat.questions.q_spontaneity_planning', 'assessments.quickCompat.questions.q_family_involvement', 'assessments.quickCompat.questions.q_comm_style', 'assessments.quickCompat.questions.q_conflict_resolution', 'assessments.quickCompat.questions.q_social_circle', 'assessments.quickCompat.questions.q_travel_preference', 'assessments.quickCompat.questions.q_dietary_habits'],
            advanced: ['assessments.quickCompat.questions.q_financial_stability', 'assessments.quickCompat.questions.q_indoors_outdoors', 'assessments.quickCompat.questions.q_personal_space', 'assessments.quickCompat.questions.q_spontaneity_planning', 'assessments.quickCompat.questions.q_family_involvement', 'assessments.quickCompat.questions.q_comm_style', 'assessments.quickCompat.questions.q_conflict_resolution', 'assessments.quickCompat.questions.q_social_circle', 'assessments.quickCompat.questions.q_travel_preference', 'assessments.quickCompat.questions.q_dietary_habits', 'assessments.quickCompat.questions.q_long_term_goals', 'assessments.quickCompat.questions.q_parenting_style', 'assessments.quickCompat.questions.q_spirituality', 'assessments.quickCompat.questions.q_political_views', 'assessments.quickCompat.questions.q_cultural_background_match'],
            options: {
                q_financial_stability: ['assessments.quickCompat.options.opt_not_important', 'assessments.quickCompat.options.opt_somewhat_important', 'assessments.quickCompat.options.opt_very_important'],
                q_indoors_outdoors: ['assessments.quickCompat.options.opt_indoors', 'assessments.quickCompat.options.opt_outdoors', 'assessments.quickCompat.options.opt_both'],
                q_personal_space: ['assessments.quickCompat.options.opt_rarely', 'assessments.quickCompat.options.opt_sometimes', 'assessments.quickCompat.options.opt_often'],
                q_spontaneity_planning: ['assessments.quickCompat.options.opt_spontaneity', 'assessments.quickCompat.options.opt_planning', 'assessments.quickCompat.options.opt_both'],
                q_family_involvement: ['assessments.quickCompat.options.opt_not_important', 'assessments.quickCompat.options.opt_somewhat_important', 'assessments.quickCompat.options.opt_very_important'],
                q_comm_style: ['assessments.quickCompat.options.opt_direct', 'assessments.quickCompat.options.opt_indirect'],
                q_conflict_resolution: ['assessments.quickCompat.options.opt_discuss_now', 'assessments.quickCompat.options.opt_cool_off'],
                q_social_circle: ['assessments.quickCompat.options.opt_small_circle', 'assessments.quickCompat.options.opt_large_network'],
                q_travel_preference: ['assessments.quickCompat.options.opt_relaxing', 'assessments.quickCompat.options.opt_adventure'],
                q_dietary_habits: ['assessments.quickCompat.options.opt_anything', 'assessments.quickCompat.options.opt_specific_diet'],
                q_long_term_goals: ['assessments.quickCompat.options.opt_career_focus', 'assessments.quickCompat.options.opt_family_focus', 'assessments.quickCompat.options.opt_balance_both'],
                q_parenting_style: ['assessments.quickCompat.options.opt_strict', 'assessments.quickCompat.options.opt_lenient', 'assessments.quickCompat.options.opt_authoritative'],
                q_spirituality: ['assessments.quickCompat.options.opt_very_spiritual', 'assessments.quickCompat.options.opt_somewhat_spiritual', 'assessments.quickCompat.options.opt_not_spiritual'],
                q_political_views: ['assessments.quickCompat.options.opt_similar_views', 'assessments.quickCompat.options.opt_differences_ok'],
                q_cultural_background_match: ['assessments.quickCompat.options.opt_important_match', 'assessments.quickCompat.options.opt_not_important_match']
            }
        };

        document.querySelectorAll('#quickCompatLevelSelector button[data-level]').forEach(button => {
            button.addEventListener('click', () => startQuickCompatQuiz(button.dataset.level));
        });
        document.getElementById('resetQuickCompatBtn')?.addEventListener('click', resetQuickCompatQuiz);


        function startQuickCompatQuiz(level) {
            showLoading(true);
            currentQuickCompatIndex = 0;
            quickCompatUserAnswers = [];
            currentQuickCompatQuizData.level = level;
            currentQuickCompatQuizData.questions = quickCompatQuestionSets[level] || [];
            document.getElementById('quickCompatLevelSelector').style.display = 'none';
            document.getElementById('quickCompatResultArea').style.display = 'none';
            document.getElementById('quickCompatQuizArea').style.display = 'block';
            loadQuickCompatQuestion();
            showLoading(false);
        }

        function loadQuickCompatQuestion() {
            if (currentQuickCompatIndex < currentQuickCompatQuizData.questions.length) {
                const questionKey = currentQuickCompatQuizData.questions[currentQuickCompatIndex];
                document.getElementById('quickCompatQuestionText').textContent = i18next.t(questionKey);
                const optionsArea = document.getElementById('quickCompatOptionsArea');
                optionsArea.innerHTML = '';
                const questionShortKey = questionKey.substring(questionKey.lastIndexOf('.') + 1);
                const optionKeys = quickCompatQuestionSets.options[questionShortKey] || [];
                optionKeys.forEach(optKey => {
                    const btn = document.createElement('button');
                    btn.textContent = i18next.t(optKey);
                    btn.onclick = () => selectQuickCompatOption(btn, optKey);
                    optionsArea.appendChild(btn);
                });
                document.getElementById('quickCompatCounter').textContent = currentQuickCompatIndex + 1;
                document.getElementById('quickCompatTotal').textContent = currentQuickCompatQuizData.questions.length;
                const progressBarFill = document.getElementById('quickCompatProgressBar');
                progressBarFill.style.width = `${((currentQuickCompatIndex + 1) / currentQuickCompatQuizData.questions.length) * 100}%`;
                progressBarFill.textContent = `${Math.round(((currentQuickCompatIndex + 1) / currentQuickCompatQuizData.questions.length) * 100)}%`;

                document.getElementById('quickCompatNextBtn').disabled = true;
            } else {
                showQuickCompatResults();
            }
        }
        function selectQuickCompatOption(selectedButton, optionKey) {
            document.querySelectorAll('#quickCompatOptionsArea button').forEach(btn => btn.classList.remove('selected'));
            selectedButton.classList.add('selected');
            const weight = document.getElementById('quickCompatWeight').value;
            quickCompatUserAnswers[currentQuickCompatIndex] = { question: currentQuickCompatQuizData.questions[currentQuickCompatIndex], answer: optionKey, weight: parseInt(weight) };
            document.getElementById('quickCompatNextBtn').disabled = false;
        }
        document.getElementById('quickCompatWeight')?.addEventListener('input', function() { document.getElementById('quickCompatWeightValue').textContent = this.value; });
        document.getElementById('quickCompatNextBtn')?.addEventListener('click', () => { 
            if (quickCompatUserAnswers[currentQuickCompatIndex]) {
                currentQuickCompatIndex++; 
                loadQuickCompatQuestion(); 
            } else {
                showNotification(i18next.t('alerts.selectionNeeded'), 'error');
            }
        });
        
        async function showQuickCompatResults() {
            document.getElementById('quickCompatQuizArea').style.display = 'none';
            document.getElementById('quickCompatResultArea').style.display = 'block';
            document.getElementById('quickCompatFinalFeedback').textContent = i18next.t('assessments.quickCompat.results.completed') + ` ${currentQuickCompatQuizData.level} ${i18next.t('assessments.quickCompat.results.checkWith')} ${quickCompatUserAnswers.length} ${i18next.t('assessments.quickCompat.results.answers')}.`;
            
            const profileRef = getProfileRef();
            if (profileRef && firebaseInitialized && db) {
                showLoading(true);
                try {
                    const assessmentRecord = {
                        name: `Quick Compatibility - ${currentQuickCompatQuizData.level}`,
                        completedAt: serverTimestamp(),
                        level: currentQuickCompatQuizData.level,
                        answers: quickCompatUserAnswers
                    };
                    await updateDoc(profileRef, {
                        assessments: arrayUnion(assessmentRecord),
                        [`profileData.quickCompat_${currentQuickCompatQuizData.level}`]: quickCompatUserAnswers // Store answers in profileData too
                    });
                    showNotification("Quick compat results saved to your profile.", "success");
                    updateProfileDisplay(); // Refresh profile display
                } catch (error) {
                    console.error("Error saving quick compat results:", error);
                    showNotification("Error saving quick compat results: " + error.message, "error");
                } finally {
                    showLoading(false);
                }
            }
        }
        function resetQuickCompatQuiz() {
            document.getElementById('quickCompatLevelSelector').style.display = 'block';
            document.getElementById('quickCompatQuizArea').style.display = 'none';
            document.getElementById('quickCompatResultArea').style.display = 'none';
        }

        let currentDetailsIndex = 0;
        let detailsUserAnswers = []; 
        const detailsQuestionKeys = Object.keys(translations.en.translation.assessments.profileBuilder.questions); 
        document.getElementById('resetDetailsQuizBtn')?.addEventListener('click', resetDetailsQuiz);


        function startDetailsQuiz() {
            showLoading(true);
            currentDetailsIndex = 0;
            detailsUserAnswers = [];
            document.getElementById('detailsResultArea').style.display = 'none';
            document.getElementById('relationshipDetailsQuizArea').style.display = 'block';
            loadDetailsQuestion();
            showLoading(false);
        }
        function loadDetailsQuestion() {
            if (currentDetailsIndex < detailsQuestionKeys.length) {
                const questionKey = detailsQuestionKeys[currentDetailsIndex];
                document.getElementById('detailsQuestionText').textContent = i18next.t(questionKey);
                const optionsArea = document.getElementById('detailsOptionsArea');
                optionsArea.innerHTML = ''; 
                const allProfileBuilderOptions = translations.en.translation.assessments.profileBuilder.options; 
                const qShortKey = questionKey.substring(questionKey.lastIndexOf('.') + 1);
                
                let currentOptionsForQuestion = [];
                const specificOptionsKey = qShortKey + '_opts'; // e.g. q_love_language_give_opts
                
                // Determine options based on question type or specific option definition
                if (qShortKey === 'q_love_language_give' || qShortKey === 'q_love_language_receive') {
                    currentOptionsForQuestion = ['words', 'acts', 'gifts', 'quality_time', 'touch'].map(o => `assessments.profileBuilder.options.${o}`);
                } else if (qShortKey === 'q_financial_transparency_scale') {
                    currentOptionsForQuestion = ["1", "2", "3", "4", "5"].map(o => `assessments.profileBuilder.options.${o}`);
                } else if (qShortKey === 'q_stress_handling') {
                    currentOptionsForQuestion = ['talk_it_out', 'alone_time', 'distract_myself', 'exercise'].map(o => `assessments.profileBuilder.options.${o}`);
                } else if (qShortKey === 'q_family_involvement_expectations') {
                     currentOptionsForQuestion = ['very_involved', 'moderately_involved', 'minimal_involvement'].map(o => `assessments.profileBuilder.options.${o}`);
                } else if (qShortKey === 'q_spiritual_beliefs_match_importance') {
                     currentOptionsForQuestion = ['very_important', 'somewhat_important', 'not_important'].map(o => `assessments.profileBuilder.options.${o}`);
                } else if (qShortKey === 'q_children_stance') {
                    currentOptionsForQuestion = ['definitely_want', 'open_to_discussion', 'prefer_not', 'undecided'].map(o => `assessments.profileBuilder.options.${o}`);
                } else if (qShortKey === 'q_past_relationships_discussion') {
                    currentOptionsForQuestion = ['open_book', 'some_details_ok', 'prefer_not_much'].map(o => `assessments.profileBuilder.options.${o}`);
                } else if (qShortKey === 'q_lobola_view') {
                    currentOptionsForQuestion = ['essential_tradition', 'important_cultural', 'open_to_modern', 'not_applicable'].map(o => `assessments.profileBuilder.options.${o}`);
                } else if (qShortKey === 'q_household_responsibilities') {
                     currentOptionsForQuestion = ['strictly_50_50', 'based_on_time_skill', 'flexible_circumstances', 'outsource_some'].map(o => `assessments.profileBuilder.options.${o}`);
                } else { // Fallback if no specific options defined
                    currentOptionsForQuestion = [
                        'assessments.profileBuilder.options.very_important',
                        'assessments.profileBuilder.options.somewhat_important',
                        'assessments.profileBuilder.options.not_important'
                    ];
                }


                currentOptionsForQuestion.forEach(optKeyOrText => {
                    const btn = document.createElement('button');
                    const optionText = i18next.exists(optKeyOrText) ? i18next.t(optKeyOrText) : optKeyOrText;
                    btn.textContent = optionText;
                    btn.onclick = () => selectDetailsOption(btn, optKeyOrText);
                    optionsArea.appendChild(btn);
                });

                document.getElementById('detailsCounter').textContent = currentDetailsIndex + 1;
                document.getElementById('detailsTotal').textContent = detailsQuestionKeys.length;
                const progressBarFill = document.getElementById('detailsProgressBar');
                progressBarFill.style.width = `${((currentDetailsIndex + 1) / detailsQuestionKeys.length) * 100}%`;
                progressBarFill.textContent = `${Math.round(((currentDetailsIndex + 1) / detailsQuestionKeys.length) * 100)}%`;
                document.getElementById('detailsNextBtn').disabled = true;
            } else {
                showDetailsResults();
            }
        }
        function selectDetailsOption(selectedButton, optionKeyOrText) {
            document.querySelectorAll('#detailsOptionsArea button').forEach(btn => btn.classList.remove('selected'));
            selectedButton.classList.add('selected');
            const weight = document.getElementById('detailsWeight').value;
            detailsUserAnswers[currentDetailsIndex] = { question: detailsQuestionKeys[currentDetailsIndex], answer: optionKeyOrText, weight: parseInt(weight) };
            document.getElementById('detailsNextBtn').disabled = false;
        }
        document.getElementById('detailsWeight')?.addEventListener('input', function() { document.getElementById('detailsWeightValue').textContent = this.value; });
        document.getElementById('detailsNextBtn')?.addEventListener('click', () => { 
            if (detailsUserAnswers[currentDetailsIndex]) {
                currentDetailsIndex++; 
                loadDetailsQuestion(); 
            } else {
                 showNotification(i18next.t('alerts.selectionNeeded'), 'error');
            }
        });
        
        async function showDetailsResults() {
            document.getElementById('relationshipDetailsQuizArea').style.display = 'none';
            document.getElementById('detailsResultArea').style.display = 'block';
            document.getElementById('detailsFinalFeedback').textContent = i18next.t('assessments.profileBuilder.results.completedWith') + ` ${detailsUserAnswers.length} ${i18next.t('assessments.profileBuilder.results.answers')}.`;
            
            const profileRef = getProfileRef();
            if (profileRef && firebaseInitialized && db) {
                showLoading(true);
                try {
                    const assessmentRecord = {
                        name: "Relationship Profile Builder",
                        completedAt: serverTimestamp(),
                        answers: detailsUserAnswers
                    };
                    // Store each answer in profileData under its question key for easier access
                    const profileDataUpdates = {};
                    detailsUserAnswers.forEach(ans => {
                        const qKey = ans.question.substring(ans.question.lastIndexOf('.') + 1); // e.g., q_love_language_give
                        profileDataUpdates[qKey] = { answer: ans.answer, weight: ans.weight };
                    });

                    await updateDoc(profileRef, {
                        assessments: arrayUnion(assessmentRecord),
                        profileData: { ...profileDataUpdates } // Overwrite or merge profileData section
                    });
                    showNotification("Profile builder results saved.", "success");
                    updateProfileDisplay(); // Refresh profile
                } catch (error) {
                    console.error("Error saving profile builder results:", error);
                    showNotification("Error saving profile builder results: " + error.message, "error");
                } finally {
                    showLoading(false);
                }
            }
        }
        function resetDetailsQuiz() { startDetailsQuiz(); } 

        // --- User Generated Questions (UGQ) ---
        const ugqFormEl = document.getElementById('ugqForm');
        ugqFormEl?.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!firebaseInitialized || !currentUserId) { showNotification("Please log in to add questions.", "error"); return; }
            showLoading(true);
            const questionText = sanitizeInput(document.getElementById('ugqText').value.trim());
            const answerText = sanitizeInput(document.getElementById('ugqAnswer').value.trim());
            const category = sanitizeInput(document.getElementById('ugqCategory').value.trim());
            const isPrivate = document.getElementById('ugqIsPrivate').checked;

            if (!questionText || !answerText) {
                showNotification(i18next.t('alerts.ugqFieldsMissing'), 'error'); showLoading(false); return;
            }
            const profileRef = getProfileRef();
            if (!profileRef) { showNotification("Please log in to save questions.", "error"); showLoading(false); return; }

            const newUgq = { 
                id: `ugq_${Date.now()}_${Math.random().toString(36).substring(2,7)}`, // Unique ID for the question
                questionText, 
                answerText, 
                category, 
                isPrivate, 
                createdAt: serverTimestamp() 
            };
            try {
                await updateDoc(profileRef, { userGeneratedQuestions: arrayUnion(newUgq) });
                showNotification(i18next.t('alerts.ugqSaved'), 'success');
                ugqFormEl.reset();
                updateProfileDisplay(); 
            } catch (error) {
                console.error("Error saving UGQ:", error);
                showNotification(i18next.t('alerts.ugqError') + ` ${error.message}`, 'error');
            }
            showLoading(false);
        });

        function renderUserGeneratedQuestionsList(ugqs = [], containerEl, isProfileView = false) {
            if (!containerEl) return;
            containerEl.innerHTML = '';
            if (ugqs.length === 0) {
                containerEl.innerHTML = `<p class="text-center p-4">${i18next.t('profile.ugqNone')}</p>`;
                return;
            }
            ugqs.forEach((ugq, index) => {
                const itemDiv = document.createElem
